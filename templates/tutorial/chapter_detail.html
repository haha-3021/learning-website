{% extends 'base.html' %}
{% load static %}

{% block title %}{{ chapter.title }} - Pythonè¨˜ç‰©æœ¬å­¦ç¿’ã‚·ã‚¹ãƒ†ãƒ {% endblock %}

{% block extra_css %}
<style>
.chapter-detail-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem;
}

/* ãƒ˜ãƒƒãƒ€ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
.chapter-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 2rem;
    border-radius: 15px;
    margin-bottom: 2rem;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    position: relative;
    overflow: hidden;
}

.chapter-header::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
    transform: rotate(45deg);
    animation: shine 6s infinite;
}

@keyframes shine {
    0% { transform: translateX(-100%) rotate(45deg); }
    100% { transform: translateX(100%) rotate(45deg); }
}

.chapter-title-section {
    position: relative;
    z-index: 2;
}

.chapter-title {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 1rem;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
}

.chapter-description {
    font-size: 1.2rem;
    opacity: 0.9;
    margin-bottom: 1.5rem;
    line-height: 1.6;
}

.chapter-meta {
    display: flex;
    gap: 2rem;
    flex-wrap: wrap;
}

.meta-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background: rgba(255,255,255,0.2);
    padding: 0.5rem 1rem;
    border-radius: 25px;
    backdrop-filter: blur(10px);
}

/* é€²æ—ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
.progress-section {
    background: white;
    padding: 1.5rem;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    margin-bottom: 2rem;
    border-left: 5px solid #4CAF50;
}

.progress-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.progress-title {
    font-size: 1.3rem;
    color: #2c3e50;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.progress-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.stat-card {
    background: #f8f9fa;
    padding: 1rem;
    border-radius: 8px;
    text-align: center;
    transition: transform 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-2px);
}

.stat-number {
    font-size: 1.8rem;
    font-weight: bold;
    color: #2c3e50;
    margin-bottom: 0.5rem;
}

.stat-label {
    color: #6c757d;
    font-size: 0.9rem;
}

.progress-actions {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
}

/* å­¦ç¿’ã‚¬ã‚¤ãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
.study-guide-section {
    background: white;
    border-radius: 12px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    border: 1px solid #e9ecef;
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #f0f0f0;
}

.section-title {
    font-size: 1.5rem;
    color: #2c3e50;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.guide-content {
    line-height: 1.8;
    font-size: 1.1rem;
    color: #4a5568;
}

.guide-content h1, .guide-content h2, .guide-content h3 {
    color: #2c3e50;
    margin-top: 1.5rem;
    margin-bottom: 1rem;
}

.guide-content p {
    margin-bottom: 1rem;
}

.guide-content code {
    background: #f7fafc;
    padding: 0.2rem 0.4rem;
    border-radius: 4px;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 0.9rem;
    color: #e53e3e;
}

.guide-content pre {
    background: #2d3748;
    color: #e2e8f0;
    padding: 1rem;
    border-radius: 8px;
    overflow-x: auto;
    margin: 1.5rem 0;
}

.guide-content pre code {
    background: none;
    color: inherit;
    padding: 0;
}

/* å•é¡Œã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
.questions-section {
    background: white;
    border-radius: 12px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.question-item {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    border-left: 4px solid #3498db;
    transition: all 0.3s ease;
}

.question-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.1);
}

.question-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
    gap: 1rem;
}

.question-text {
    font-size: 1.1rem;
    font-weight: 600;
    color: #2c3e50;
    line-height: 1.6;
    flex: 1;
}

.question-meta {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.question-type {
    background: #3498db;
    color: white;
    padding: 0.3rem 0.8rem;
    border-radius: 15px;
    font-size: 0.8rem;
    font-weight: 500;
}

.question-difficulty {
    background: #e74c3c;
    color: white;
    padding: 0.3rem 0.8rem;
    border-radius: 15px;
    font-size: 0.8rem;
    font-weight: 500;
}

.question-difficulty.easy {
    background: #27ae60;
}

.question-difficulty.medium {
    background: #f39c12;
}

.code-snippet {
    background: #2d3748;
    color: #e2e8f0;
    padding: 1rem;
    border-radius: 8px;
    margin: 1rem 0;
    overflow-x: auto;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 0.9rem;
}

/* é¸æŠè‚¢ */
.choices-container {
    margin: 1.5rem 0;
}

.choice-item {
    background: white;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 0.8rem;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 1rem;
}

.choice-item:hover {
    border-color: #3498db;
    background: #f8f9ff;
}

.choice-item.selected {
    border-color: #3498db;
    background: #e3f2fd;
}

.choice-radio {
    width: 20px;
    height: 20px;
    border: 2px solid #bdc3c7;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.choice-item.selected .choice-radio {
    border-color: #3498db;
    background: #3498db;
}

.choice-item.selected .choice-radio::after {
    content: '';
    width: 8px;
    height: 8px;
    background: white;
    border-radius: 50%;
}

.choice-text {
    flex: 1;
    font-size: 1rem;
    color: #2c3e50;
}

/* ç©ºæ¬„å•é¡Œã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆå˜ä¸€ï¼†è¤‡æ•°å…±é€šï¼‰ */
.fill-blank-container {
    margin: 1.5rem 0;
}

/* æ‰€æœ‰å¡«ç©ºè¾“å…¥æ¡†ç»Ÿä¸€é£æ ¼ï¼ˆå¤§æ°”ä¸€ç‚¹çš„èƒ¶å›Šè¾“å…¥æ¡†ï¼‰ */
.blank-input {
    display: inline-flex;
    align-items: center;
    width: 260px;
    max-width: 100%;
    margin: 0.25rem 0;
    padding: 0.75rem 1rem;
    border-radius: 999px;
    border: 2px solid #d0d7e2;
    background: #f8fafc;
    font-size: 1rem;
    color: #2c3e50;
    text-align: left;
    box-shadow: 0 4px 10px rgba(15, 23, 42, 0.05);
    transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease, transform 0.1s ease;
}

.blank-input:focus {
    outline: none;
    border-color: #3498db;
    background: #ffffff;
    box-shadow: 0 8px 22px rgba(52, 152, 219, 0.25);
    transform: translateY(-1px);
}

.blank-input::placeholder {
    color: #a0aec0;
    font-size: 0.9rem;
}

.blank-hint {
    font-size: 0.9rem;
    color: #7f8c8d;
    margin-top: 0.5rem;
}

/* å¤šå¡«ç©ºé¢˜æ ·å¼ï¼ˆå¸ƒå±€ä¸ºç«–å‘ã€å·¦labelå³è¾“å…¥ã€å¡ç‰‡é£ï¼‰ */
.question-multi-fill .question-text {
    margin-bottom: 20px;
    line-height: 1.6;
}

.multi-blanks-container {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-bottom: 20px;
}

.blank-input-group {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 12px;
    border-radius: 12px;
    background: #ffffff;
    border: 1px solid #edf2f7;
    box-shadow: 0 2px 6px rgba(15, 23, 42, 0.03);
}

.blank-input-group label {
    min-width: 90px;
    font-weight: 600;
    color: #4a5568;
    font-size: 0.9rem;
    white-space: nowrap;
}

.blank-input-group .blank-input {
    flex: 1;
    margin: 0;
}

/* ãƒ’ãƒ³ãƒˆãƒœã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ« */
.hint-button {
    background: linear-gradient(135deg, #FFD93D, #FF9A3D);
    color: white;
    border: none;
    padding: 0.8rem 1.5rem;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 600;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
}

.hint-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(255, 157, 61, 0.3);
}

.hint-button:disabled {
    background: #bdc3c7;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

/* ãƒ’ãƒ³ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¹ã‚¿ã‚¤ãƒ« */
.hint-modal-content {
    background: white;
    padding: 2rem;
    border-radius: 12px;
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    position: relative;
}

.hint-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #f0f0f0;
}

.hint-modal-title {
    margin: 0;
    color: #2c3e50;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.hint-modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: #7f8c8d;
    padding: 0.5rem;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.3s ease;
}

.hint-modal-close:hover {
    background: #f8f9fa;
}

.hint-modal-body {
    line-height: 1.6;
    color: #2c3e50;
    font-size: 1.1rem;
}

.hint-modal-footer {
    margin-top: 2rem;
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
}

/* å›ç­”ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ */
.answer-actions {
    display: flex;
    gap: 1rem;
    margin-top: 1.5rem;
    flex-wrap: wrap;
}

.btn {
    padding: 0.8rem 1.5rem;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 600;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    text-decoration: none;
}

.btn-primary {
    background: linear-gradient(135deg, #3498db, #2980b9);
    color: white;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(52, 152, 219, 0.3);
}

.btn-success {
    background: linear-gradient(135deg, #27ae60, #229954);
    color: white;
}

.btn-success:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(39, 174, 96, 0.3);
}

.btn-secondary {
    background: #95a5a6;
    color: white;
}

.btn-secondary:hover {
    background: #7f8c8d;
    transform: translateY(-2px);
}

.btn-outline {
    background: transparent;
    border: 2px solid #3498db;
    color: #3498db;
}

.btn-outline:hover {
    background: #3498db;
    color: white;
    transform: translateY(-2px);
}

/* è§£èª¬ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
.explanation-section {
    background: #e8f5e8;
    border-radius: 8px;
    padding: 1.5rem;
    margin-top: 1.5rem;
    border-left: 4px solid #27ae60;
    display: none;
}

.explanation-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1rem;
    color: #27ae60;
    font-weight: 600;
}

.explanation-content {
    line-height: 1.6;
    color: #2c3e50;
}

/* å®Œäº†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
.completion-section {
    background: linear-gradient(135deg, #27ae60, #229954);
    color: white;
    padding: 2rem;
    border-radius: 12px;
    text-align: center;
    margin-top: 2rem;
    display: none;
}

.completion-icon {
    font-size: 4rem;
    margin-bottom: 1rem;
}

.completion-message {
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: 1rem;
}

/* å­¦ç¿’æ™‚é–“è¡¨ç¤º */
.study-time-display {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: rgba(52, 152, 219, 0.9);
    color: white;
    padding: 1rem 1.5rem;
    border-radius: 10px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    z-index: 1000;
    backdrop-filter: blur(10px);
    display: none;
}

.study-time-text {
    font-size: 0.9rem;
    margin-bottom: 0.3rem;
}

.study-time-value {
    font-size: 1.2rem;
    font-weight: 600;
}

/* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ */
@media (max-width: 768px) {
    .chapter-detail-container {
        padding: 1rem;
    }
    
    .chapter-header {
        padding: 1.5rem;
    }
    
    .chapter-title {
        font-size: 2rem;
    }
    
    .chapter-meta {
        flex-direction: column;
        gap: 1rem;
    }
    
    .progress-stats {
        grid-template-columns: 1fr;
    }
    
    .progress-actions {
        flex-direction: column;
    }
    
    .question-header {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .question-meta {
        width: 100%;
        justify-content: flex-start;
    }
    
    .answer-actions {
        flex-direction: column;
    }
    
    .btn {
        width: 100%;
        justify-content: center;
    }
    
    .study-time-display {
        bottom: 10px;
        right: 10px;
        left: 10px;
        text-align: center;
    }
}

@media (max-width: 480px) {
    .chapter-title {
        font-size: 1.8rem;
    }
    
    .section-title {
        font-size: 1.3rem;
    }
    
    .study-guide-section,
    .questions-section {
        padding: 1.5rem;
    }
    
    .question-item {
        padding: 1rem;
    }
}

/* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.chapter-header,
.progress-section,
.study-guide-section,
.questions-section {
    animation: fadeIn 0.6s ease-out;
}

.question-item {
    animation: fadeIn 0.4s ease-out;
}

/* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º */
::-webkit-scrollbar {
    width: 8px;
}

::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
}

::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* æœ¬åœ°åé¦ˆæ ·å¼ï¼ˆç»Ÿä¸€æˆå¡ç‰‡é£ï¼‰ */
.local-feedback {
    margin: 16px 0;
    min-height: 40px;
    transition: all 0.2s ease;
}

.alert {
    position: relative;
    padding: 12px 16px 12px 18px;
    border-radius: 10px;
    margin: 8px 0;
    border-left: 4px solid #3498db;
    background: #f8fbff;
    font-size: 0.9rem;
    color: #2c3e50;
    box-shadow: 0 2px 8px rgba(15, 23, 42, 0.06);
    animation: slideIn 0.25s ease-out;
}

/* æ­£è§£ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
.alert-success {
    border-left-color: #27ae60;
    background: #e8f5e9;
}

/* ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
.alert-error {
    border-left-color: #e74c3c;
    background: #fdecea;
}

/* æƒ…å ±ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
.alert-info {
    border-left-color: #3498db;
    background: #e8f3ff;
}

/* æ­£è§£ãƒ»é”™è¯¯è§£é‡Šçš„å°åŠ¨ç”» */
@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* â˜…å…±é€šã®éè¡¨ç¤ºã‚¯ãƒ©ã‚¹ï¼ˆã‚¬ã‚¤ãƒ‰â†’å•é¡Œåˆ‡ã‚Šæ›¿ãˆç”¨ï¼‰ */
.hidden {
    display: none !important;
}

@keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>
{% endblock %}

{% block content %}
<div class="chapter-detail-container">
    <!-- ãƒãƒ£ãƒ—ã‚¿ãƒ¼ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="chapter-header">
        <div class="chapter-title-section">
            <h1 class="chapter-title">{{ chapter.title }}</h1>
            <p class="chapter-description">{{ chapter.description }}</p>
            <div class="chapter-meta">
                <div class="meta-item">
                    <span>ğŸ“š</span>
                    <span>ç¬¬ {{ chapter.order }} ç« </span>
                </div>
                <div class="meta-item">
                    <span>â“</span>
                    <span>{{ chapter.get_question_count }} å•</span>
                </div>
                <div class="meta-item">
                    <span>â±ï¸</span>
                    <span id="currentStudyTime">å­¦ç¿’æ™‚é–“: è¨ˆæ¸¬ä¸­...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- é€²æ—ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="progress-section">
        <div class="progress-header">
            <h2 class="progress-title">ğŸ“Š å­¦ç¿’é€²æ—</h2>
            <div class="progress-status">
                {% if user_progress.completed %}
                <span style="color: #27ae60; font-weight: 600;">âœ… å®Œäº†</span>
                {% elif user_progress.studied_guide %}
                <span style="color: #f39c12; font-weight: 600;">ğŸ“– å­¦ç¿’ä¸­</span>
                {% else %}
                <span style="color: #e74c3c; font-weight: 600;">ğŸ”’ æœªé–‹å§‹</span>
                {% endif %}
            </div>
        </div>
        
        <div class="progress-stats">
            <div class="stat-card">
                <div class="stat-number">{{ chapter.get_question_count }}</div>
                <div class="stat-label">å•é¡Œæ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">
                    <span id="current-score-display">
                        {% if user_progress.score %}{{ user_progress.score }}{% else %}0{% endif %}%
                    </span>%
                </div>
                <div class="stat-label">ã‚¹ã‚³ã‚¢</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">
                    {% if user_progress.completed %}âœ…{% else %}â³{% endif %}
                </div>
                <div class="stat-label">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div>
            </div>
        </div>
        
        <div class="progress-actions">
            {% if not user_progress.studied_guide and study_guide %}
            <button class="btn btn-primary" onclick="markGuideStudied()">
                ğŸ“– å­¦ç¿’ã‚¬ã‚¤ãƒ‰ã‚’èª­äº†
            </button>
            {% endif %}
            
            {% if not user_progress.completed %}
            <button class="btn btn-success" onclick="completeChapter()" 
                    {% if study_guide and not user_progress.studied_guide %}disabled{% endif %}>
                ğŸ¯ ãƒãƒ£ãƒ—ã‚¿ãƒ¼ã‚’å®Œäº†
            </button>
            {% endif %}

            <button class="btn btn-secondary" onclick="exitChapter()">
                ğŸšª ãƒãƒ£ãƒ—ã‚¿ãƒ¼ã‚’ä¸­æ–­ã—ã¦é€€å‡º
            </button>
            
            <button class="btn btn-outline" onclick="confirmAndResetProgress({{ chapter.id }})">
                ğŸ”„ é€²æ—ã‚’ãƒªã‚»ãƒƒãƒˆ
            </button>
        </div>
    </div>

    <!-- å­¦ç¿’ã‚¬ã‚¤ãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    {% if study_guide %}
    <div class="study-guide-section" id="studyGuideSection">
        <div class="section-header">
            <h2 class="section-title">ğŸ“˜ å­¦ç¿’ã‚¬ã‚¤ãƒ‰</h2>
            {% if user_progress.studied_guide %}
            <span style="color: #27ae60; font-weight: 600;">âœ… èª­äº†æ¸ˆã¿</span>
            {% endif %}
        </div>
        <div class="guide-content">
            {{ study_guide.content|safe }}
        </div>

        {# æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ« #}
        {% if study_guide.attachments.all %}
            {% if study_guide.attachments.all|length > 0 %}
            <div class="study-guide-attachments" style="margin-top: 1.5rem;">
                <h3>ğŸ“ ã“ã®ãƒãƒ£ãƒ—ã‚¿ãƒ¼ã®æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«</h3>
                <ul>
                    {% for att in study_guide.attachments.all %}
                        <li>
                            <a href="{{ att.file.url }}" download>
                                {{ att.display_name|default:"æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«" }}
                            </a>
                        </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        {% endif %}

        {% if not user_progress.studied_guide %}
        <div class="answer-actions">
            <button class="btn btn-primary" onclick="markGuideStudied()">
                âœ… å­¦ç¿’ã‚¬ã‚¤ãƒ‰ã‚’èª­äº†ã¨ã—ã¦ãƒãƒ¼ã‚¯
            </button>
            <button class="btn btn-success" onclick="goToQuestions()">
                ğŸ¯ ç·´ç¿’å•é¡Œã«é€²ã‚€
            </button>
        </div>
        {% else %}
        <div class="answer-actions">
            <button class="btn btn-success" onclick="goToQuestions()">
                ğŸ¯ ç·´ç¿’å•é¡Œã«é€²ã‚€
            </button>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- å•é¡Œã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="questions-section {% if study_guide %}hidden{% endif %}" id="questionsSection">
        <div class="section-header">
            <h2 class="section-title">â“ ç·´ç¿’å•é¡Œ</h2>
            <span class="questions-count">{{ questions|length }} å•</span>
        </div>
        
        {% for question in questions %}
        <div class="question-item {% if question.question_type == 'multi_fill' %}question-multi-fill{% endif %}"
            id="question-{{ question.id }}"
            data-question-type="{{ question.question_type }}"
            data-user-answer="{{ question.user_answer|default_if_none:'' }}"
            data-user-correct="{% if question.user_is_correct %}1{% else %}0{% endif %}">
            <div class="question-header">
                <div class="question-text">{{ question.question_text|safe }}</div>
                <div class="question-meta">
                    <span class="question-type">
                        {% if question.question_type == 'choice' %}é¸æŠå•é¡Œ
                        {% elif question.question_type == 'fill' %}ç©´åŸ‹ã‚å•é¡Œï¼ˆå˜ä¸€ç©ºï¼‰
                        {% elif question.question_type == 'multi_fill' %}ç©´åŸ‹ã‚å•é¡Œï¼ˆè¤‡æ•°ç©ºï¼‰
                        {% endif %}
                    </span>
                    <span class="question-difficulty {{ question.difficulty|lower }}">
                        {% if question.difficulty == 'easy' %}æ˜“ã—ã„
                        {% elif question.difficulty == 'medium' %}æ™®é€š
                        {% elif question.difficulty == 'hard' %}é›£ã—ã„
                        {% endif %}
                    </span>
                </div>
            </div>

            {% if question.code_snippet %}
            <pre class="code-snippet"><code>{{ question.code_snippet|escape }}</code></pre>
            {% endif %}

            {% if question.question_type == 'choice' %}
            <!-- é¸æŠå¼å•é¡Œ -->
            <div class="choices-container">
                {% for choice in question.choice_set.all %}
                <div class="choice-item" onclick="selectChoice(this, '{{ choice.id }}')" data-choice-id="{{ choice.id }}">
                    <div class="choice-radio"></div>
                    <div class="choice-text">{{ choice.choice_text }}</div>
                </div>
                {% endfor %}
            </div>

            {% elif question.question_type == 'fill' %}
            <!-- å˜ä¸€ç©ºæ¬„å•é¡Œ -->
            <div class="fill-blank-container">
                <input type="text" 
                       id="answer-{{ question.id }}" 
                       class="blank-input" 
                       placeholder="å›ç­”ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„">
                <div class="blank-hint">Enterã‚­ãƒ¼ã§å›ç­”ã‚’é€ä¿¡ã§ãã¾ã™</div>
            </div>

            {% elif question.question_type == 'multi_fill' %}
            <!-- è¤‡æ•°ç©ºæ¬„å•é¡Œ -->
            <div class="multi-blank-container multi-blanks-container">
                {% for blank_num in question.get_blank_range %}
                <div class="blank-input-group">
                    <label for="blank-{{ question.id }}-{{ forloop.counter0 }}">ç©ºæ¬„ {{ forloop.counter }}:</label>
                    <input type="text" 
                        id="blank-{{ question.id }}-{{ forloop.counter0 }}" 
                        class="blank-input multi-blank"
                        placeholder="å›ç­”ã‚’å…¥åŠ›">
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
            <div class="local-feedback" id="feedback-{{ question.id }}"></div>

            <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
            <div class="answer-actions">
                <button type="button" class="btn btn-outline hint-button" onclick="showHint({{ question.id }})">
                    ğŸ’¡ ãƒ’ãƒ³ãƒˆã‚’è¦‹ã‚‹
                </button>
                <button type="button" class="btn btn-primary" onclick="submitAnswer({{ question.id }})">
                    å›ç­”ã‚’é€ä¿¡
                </button>
            </div>

            <!-- è§£èª¬ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="explanation-section" id="explanation-{{ question.id }}">
                <div class="explanation-header">
                    <span>ğŸ’¡ è§£èª¬</span>
                </div>
                <div class="explanation-content">
                    å›ç­”å¾Œã«è§£èª¬ãŒè¡¨ç¤ºã•ã‚Œã¾ã™
                </div>
            </div>
        </div>
        {% empty %}
        <div style="text-align: center; padding: 3rem; color: #7f8c8d;">
            <p>ã“ã®ãƒãƒ£ãƒ—ã‚¿ãƒ¼ã«ã¯å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
        </div>
        {% endfor %}
    </div>

    <div id="next-chapter-section" style="display: none; text-align: center; margin: 40px 0; padding: 30px; border-top: 2px dashed #ddd;">
        <div style="background: #f9f9f9; padding: 25px; border-radius: 15px; border: 1px solid #eee;">
            {% if next_chapter %}
                <h3 style="color: #27ae60; margin-bottom: 15px;">ğŸ‰ ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼ã“ã®ãƒãƒ£ãƒ—ã‚¿ãƒ¼ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚</h3>
                <a href="{% url 'chapter_detail' next_chapter.id %}" class="btn btn-success btn-lg" style="padding: 15px 40px; font-size: 1.2rem; border-radius: 50px;">
                    æ¬¡ã®ãƒãƒ£ãƒ—ã‚¿ãƒ¼ã¸é€²ã‚€ï¼š{{ next_chapter.title }} â”
                </a>
            {% else %}
                <h3 style="color: #27ae60;">ğŸŠ å…¨ã¦ã®ãƒãƒ£ãƒ—ã‚¿ãƒ¼ã‚’å®Œäº†ã—ã¾ã—ãŸï¼</h3>
                <a href="{% url 'course_detail' chapter.course.id %}" class="btn btn-primary">
                    ã‚³ãƒ¼ã‚¹ä¸€è¦§ã«æˆ»ã‚‹
                </a>
            {% endif %}
        </div>
    </div>

    <!-- å®Œäº†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    {% if user_progress.completed %}
    <div class="completion-section" id="completionSection">
        <div class="completion-icon">ğŸ‰</div>
        <div class="completion-message">ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼</div>
        <p>ç¬¬{{ chapter.order }}ç« ã€Œ{{ chapter.title }}ã€ã‚’å®Œäº†ã—ã¾ã—ãŸï¼</p>
        <div class="answer-actions" style="justify-content: center;">
            <a href="{% url 'home' %}" class="btn btn-outline" style="background: rgba(255,255,255,0.2); color: white;">
                ğŸ  ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹
            </a>
            <a href="{% url 'wrong_answers_book' %}" class="btn btn-outline" style="background: rgba(255,255,255,0.2); color: white;">
                ğŸ“– é–“é•ã„ãƒãƒ¼ãƒˆã‚’è¦‹ã‚‹
            </a>
        </div>
    </div>
    {% endif %}
</div>

<!-- å­¦ç¿’æ™‚é–“è¡¨ç¤º -->
<div class="study-time-display" id="studyTimeDisplay">
    <div class="study-time-text">ç¾åœ¨ã®å­¦ç¿’æ™‚é–“</div>
    <div class="study-time-value" id="studyTimeValue">00:00</div>
</div>
{% endblock %}

{% block scripts %}
<script>
// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
let studySessionId = null;
let studyStartTime = null;
let studyTimer = null;
let currentStudySeconds;
let autoSaveInterval = null;
let isPageUnloading = false;


const chapterIdForStorage = "{{ chapter.id }}";
const storageKey = `study_seconds_ch_${chapterIdForStorage}`;

// â˜… å­¦ç¿’ã‚¬ã‚¤ãƒ‰ã‚’ã€Œæœ€å¾Œã¾ã§èª­ã‚“ã ã‹ã©ã†ã‹ã€ã®ãƒ•ãƒ©ã‚°
let hasReadStudyGuide = false;

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
document.addEventListener('DOMContentLoaded', function() {
    console.log('ãƒãƒ£ãƒ—ã‚¿ãƒ¼è©³ç´°ãƒšãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');

    // å­¦ç¿’æ™‚é–“è¨˜éŒ²ã‚’é–‹å§‹
    startStudyTime();
    
    // å­¦ç¿’æ™‚é–“è¡¨ç¤ºã‚’åˆæœŸåŒ–
    initializeStudyTimeDisplay();
    
    // Enterã‚­ãƒ¼ã§å›ç­”ã‚’é€ä¿¡
    setupEnterKeySubmit();

    // é€”ä¸­ä¿å­˜ã•ã‚ŒãŸå›ç­”ã‚’ç”»é¢ã«åæ˜ 
    initializeSavedAnswers();
    
    // ãƒšãƒ¼ã‚¸å¯è¦–æ€§å¤‰åŒ–ã®ç›£è¦–ã‚’ç™»éŒ²
    document.addEventListener('visibilitychange', handleVisibilityChange);
    
    // å­¦ç¿’ã‚¬ã‚¤ãƒ‰èª­äº†åˆ¤å®šã®åˆæœŸåŒ–
    initStudyGuideReadTracking();
    
    // å®Œäº†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤ºï¼ˆã‚‚ã—å®Œäº†æ¸ˆã¿ã®å ´åˆï¼‰
    {% if user_progress.completed %}
    setTimeout(() => {
        document.getElementById('completionSection').style.display = 'block';
    }, 1000);
    {% endif %}

    const stats = getQuestionStats();
    if (stats.accuracy === 100) {
        const nextBtnArea = document.getElementById('next-chapter-section');
        if (nextBtnArea) nextBtnArea.style.display = 'block';
    }
});

// â˜… ãƒãƒ£ãƒ—ã‚¿ãƒ¼ã‚’ä¸­æ–­ã—ã¦é€€å‡º
function exitChapter() {
    // å­¦ç¿’æ™‚é–“ã‚’çµ‚äº†ã—ã¦ã‹ã‚‰ãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‹
    endStudyTime().finally(() => {
        window.location.href = "{% url 'home' %}";
    });
}

// â˜… å­¦ç¿’ã‚¬ã‚¤ãƒ‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«çŠ¶æ³ã®ç›£è¦–
function initStudyGuideReadTracking() {
    const guideSection = document.getElementById('studyGuideSection');
    if (!guideSection) return;

    // ä¸­èº«ãŒå°‘ãªãã¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ãªã„å ´åˆã¯ã€æœ€åˆã‹ã‚‰ã€Œèª­äº†æ‰±ã„ã€
    if (guideSection.scrollHeight <= guideSection.clientHeight + 10) {
        hasReadStudyGuide = true;
        return;
    }

    const onScroll = () => {
        const threshold = 20; // å°‘ã—ä½™è£•ã‚’ã‚‚ãŸã›ã‚‹
        if (guideSection.scrollTop + guideSection.clientHeight >= guideSection.scrollHeight - threshold) {
            hasReadStudyGuide = true;
            // ä¸€åº¦ true ã«ãªã£ãŸã‚‰ç›£è¦–ã‚’å¤–ã—ã¦ã‚‚OK
            guideSection.removeEventListener('scroll', onScroll);
            console.log('å­¦ç¿’ã‚¬ã‚¤ãƒ‰ã‚’æœ€å¾Œã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¾ã—ãŸ');
        }
    };

    guideSection.addEventListener('scroll', onScroll);
}

// â˜… å­¦ç¿’ã‚¬ã‚¤ãƒ‰ã‹ã‚‰ç·´ç¿’å•é¡Œãƒ“ãƒ¥ãƒ¼ã¸åˆ‡ã‚Šæ›¿ãˆã‚‹
function goToQuestions() {
    // å­¦ç¿’ã‚¬ã‚¤ãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤º
    const guideSection = document.getElementById('studyGuideSection');
    if (guideSection) {
        guideSection.classList.add('hidden');
    }

    // ç·´ç¿’å•é¡Œã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
    const questionsSection = document.getElementById('questionsSection');
    if (questionsSection) {
        questionsSection.classList.remove('hidden');
    }

    // ãƒšãƒ¼ã‚¸ä¸Šéƒ¨ã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
    window.scrollTo({
        top: 0,
        behavior: 'smooth'
    });
}

// ãƒšãƒ¼ã‚¸å¯è¦–æ€§å¤‰åŒ–ã®å‡¦ç†
function handleVisibilityChange() {
    if (document.hidden) {
        if (studyTimer) {
            clearInterval(studyTimer);
            studyTimer = null;
            console.log('ãƒšãƒ¼ã‚¸éè¡¨ç¤ºï¼šã‚¿ã‚¤ãƒãƒ¼åœæ­¢ï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯ç¶­æŒï¼‰');
            // ä»…è¿›è¡Œè‡ªåŠ¨ä¿å­˜ï¼Œä¸å…³é—­ä¼šè¯
            autoSaveStudyTime();
        }
    } else {
        if (!studyTimer) {
            console.log('ãƒšãƒ¼ã‚¸è¡¨ç¤ºï¼šã‚¿ã‚¤ãƒãƒ¼å†é–‹');
            startStudyTimeDisplay();
        }
    }
}

// è‡ªå‹•ä¿å­˜å­¦ç¿’æ™‚é–“
function autoSaveStudyTime() {
    if (studySessionId && currentStudySeconds > 0 && !isPageUnloading && !document.hidden) {
        const chapterId = {{ chapter.id }};
        const finalSeconds = Math.max(currentStudySeconds, 1);
        
        console.log('è‡ªå‹•ä¿å­˜å­¦ç¿’æ™‚é–“:', { sessionId: studySessionId, seconds: finalSeconds });
        
        fetch(`/chapter/${chapterId}/update-study-time/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                study_session_id: studySessionId,
                frontend_seconds: finalSeconds,
                is_auto_save: true
            }),
            keepalive: true
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('è‡ªå‹•ä¿å­˜å¤±æ•—');
            }
            console.log('è‡ªå‹•ä¿å­˜æˆåŠŸ');
        })
        .catch(error => {
            console.error('è‡ªå‹•ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
        });
    }
}

// å®šæœŸçš„ãªè‡ªå‹•ä¿å­˜ã‚’é–‹å§‹
function startAutoSave() {
    if (autoSaveInterval) {
        clearInterval(autoSaveInterval);
    }
    
    autoSaveInterval = setInterval(() => {
        if (studySessionId && currentStudySeconds > 0 && !isPageUnloading && !document.hidden) {
            autoSaveStudyTime();
        }
    }, 30000); // 30ç§’
}

// å­¦ç¿’æ™‚é–“è¨˜éŒ²ã‚’é–‹å§‹
function startStudyTime() {
    if (studySessionId) {
        endStudyTime().then(() => {
            createNewStudySession();
        });
    } else {
        createNewStudySession();
    }
}

// æ–°ã—ã„å­¦ç¿’ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆ
function createNewStudySession() {
    // --- 1. ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰æ™‚é–“ã‚’å¾©å…ƒï¼ˆæœ€å„ªå…ˆï¼‰ ---
    const savedSeconds = localStorage.getItem(storageKey);
    if (savedSeconds !== null) {
        currentStudySeconds = parseInt(savedSeconds, 10);
        console.log('ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰æ™‚é–“ã‚’å¾©å…ƒã—ã¾ã—ãŸ:', currentStudySeconds);
    } else {
        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒãªã„å ´åˆã®ã¿åˆæœŸåŒ–
        currentStudySeconds = currentStudySeconds || 0;
    }

    // ç”»é¢è¡¨ç¤ºã‚’å³åº§ã«æ›´æ–°ï¼ˆ0è¡¨ç¤ºã®ãƒãƒ©ã¤ãã‚’é˜²æ­¢ï¼‰
    updateStudyTimeDisplay();

    // --- 2. æ—¢å­˜ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒã‚ã‚‹ã‹ç¢ºèª ---
    const currentSessionId = {% if current_session_id %}{{ current_session_id }}{% else %}null{% endif %};
    
    if (currentSessionId) {
        studySessionId = currentSessionId;
        console.log('æ—¢å­˜ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã—ã¾ã™:', studySessionId);
        
        // ã‚¿ã‚¤ãƒãƒ¼ãŒäºŒé‡ã«èµ·å‹•ã—ãªã„ã‚ˆã†ã«ãƒã‚§ãƒƒã‚¯
        if (!studyTimer) {
            startStudyTimeDisplay();
            startAutoSave();
        }
        return;
    }
    
    // --- 3. ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒãªã„å ´åˆã¯æ–°è¦ä½œæˆ ---
    const chapterId = {{ chapter.id }};
    fetch(`/chapter/${chapterId}/start-study/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            studySessionId = data.study_session_id;
            console.log('æ–°è¦ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ä½œæˆã«æˆåŠŸã—ã¾ã—ãŸ:', studySessionId);
            
            // ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜ã•ã‚ŒãŸæ™‚é–“ãŒãªã„å ´åˆã®ã¿ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®å€¤ã‚’ä½¿ç”¨
            if (!localStorage.getItem(storageKey)) {
                currentStudySeconds = data.initial_seconds || 0;
            }

            if (!studyTimer) {
                startStudyTimeDisplay();
                startAutoSave();
            }
        }
    })
    .catch(error => {
        console.error('ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹ã‚¨ãƒ©ãƒ¼:', error);
    });
}

// å­¦ç¿’æ™‚é–“è¡¨ç¤ºã‚’åˆæœŸåŒ–
function initializeStudyTimeDisplay() {
    const studyTimeDisplay = document.getElementById('studyTimeDisplay');
    if (studyTimeDisplay) {
        studyTimeDisplay.style.display = 'block';
    }
}

// å­¦ç¿’æ™‚é–“è¡¨ç¤ºã‚’é–‹å§‹
function startStudyTimeDisplay() {
    if (!studyTimer) {
        studyTimer = setInterval(() => {
            currentStudySeconds++;
            updateStudyTimeDisplay();
        }, 1000);
        console.log('å­¦ç¿’æ™‚é–“ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹');
    }
}

// å­¦ç¿’æ™‚é–“è¡¨ç¤ºã‚’æ›´æ–°
function updateStudyTimeDisplay() {
    // å…³é”®ï¼šå°†å½“å‰ç§’æ•°å®æ—¶å­˜å…¥æœ¬åœ°
    localStorage.setItem(storageKey, currentStudySeconds);

    const minutes = Math.floor(currentStudySeconds / 60);
    const seconds = currentStudySeconds % 60;
    const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    
    const studyTimeValue = document.getElementById('studyTimeValue');
    const currentStudyTime = document.getElementById('currentStudyTime');
    
    if (studyTimeValue) studyTimeValue.textContent = timeString;
    if (currentStudyTime) currentStudyTime.textContent = `å­¦ç¿’æ™‚é–“: ${timeString}`;
}

// å­¦ç¿’æ™‚é–“è¨˜éŒ²ã‚’çµ‚äº†
function endStudyTime() {
    if (!studySessionId) {
        console.log('ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªå­¦ç¿’ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯ã‚ã‚Šã¾ã›ã‚“');
        return Promise.resolve();
    }
    
    const chapterId = {{ chapter.id }};
    const finalSeconds = Math.max(currentStudySeconds, 1);
    
    console.log('å­¦ç¿’æ™‚é–“è¨˜éŒ²ã‚’çµ‚äº†:', {
        sessionId: studySessionId,
        frontendSeconds: finalSeconds,
        chapterId: chapterId
    });
    
    return fetch(`/chapter/${chapterId}/end-study/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            study_session_id: studySessionId,
            frontend_seconds: finalSeconds
        }),
        keepalive: true
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('å­¦ç¿’æ™‚é–“çµ‚äº†ãƒªã‚¯ã‚¨ã‚¹ãƒˆå¤±æ•—');
        }
        return response.json();
    })
    .then(data => {
        console.log('å­¦ç¿’æ™‚é–“çµ‚äº†æˆåŠŸ:', data);
        
        if (studyTimer) {
            clearInterval(studyTimer);
            studyTimer = null;
        }
        if (autoSaveInterval) {
            clearInterval(autoSaveInterval);
            autoSaveInterval = null;
        }
        studySessionId = null;
        currentStudySeconds = 0;
        
        return data;
    })
    .catch(error => {
        console.error('å­¦ç¿’æ™‚é–“çµ‚äº†ã‚¨ãƒ©ãƒ¼:', error);
        if (studyTimer) {
            clearInterval(studyTimer);
            studyTimer = null;
        }
        if (autoSaveInterval) {
            clearInterval(autoSaveInterval);
            autoSaveInterval = null;
        }
        studySessionId = null;
        currentStudySeconds = 0;
    });
}

// ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã®å‡¦ç†
window.addEventListener('beforeunload', function(e) {
    if (studySessionId && currentStudySeconds > 0) {
        isPageUnloading = true;
        console.log('ãƒšãƒ¼ã‚¸é–‰é–ã€å­¦ç¿’æ™‚é–“ã‚’çµ‚äº†');
        
        const chapterId = {{ chapter.id }};
        const finalSeconds = Math.max(currentStudySeconds, 1);
        
        const xhr = new XMLHttpRequest();
        xhr.open('POST', `/chapter/${chapterId}/end-study/`, false);
        xhr.setRequestHeader('X-CSRFToken', getCookie('csrftoken'));
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.send(JSON.stringify({
            study_session_id: studySessionId,
            frontend_seconds: finalSeconds
        }));
        
        console.log('åŒæœŸå­¦ç¿’æ™‚é–“çµ‚äº†ãƒªã‚¯ã‚¨ã‚¹ãƒˆå®Œäº†');
    }
});

// ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
window.addEventListener('unload', function() {
    if (autoSaveInterval) {
        clearInterval(autoSaveInterval);
    }
    if (studyTimer) {
        clearInterval(studyTimer);
    }
});

// é¸æŠå•é¡Œã®é¸æŠå‡¦ç†
function selectChoice(choiceElement, choiceId) {
    const questionItem = choiceElement.closest('.question-item');
    const allChoices = questionItem.querySelectorAll('.choice-item');
    allChoices.forEach(choice => {
        choice.classList.remove('selected');
    });
    
    choiceElement.classList.add('selected');
    choiceElement.dataset.selectedChoice = choiceId;
}

// å›ç­”ã‚’é€ä¿¡
function submitAnswer(questionId) {
    const questionElement = document.getElementById(`question-${questionId}`);
    const feedbackElement = document.getElementById(`feedback-${questionId}`);
    const explanationElement = document.getElementById(`explanation-${questionId}`);

    feedbackElement.innerHTML = '';
    
    const questionType = questionElement.dataset.questionType;
    
    let userAnswer = '';
    
    if (questionType === 'choice') {
        const selectedChoice = questionElement.querySelector('.choice-item.selected');
        if (!selectedChoice) {
            showLocalMessage(feedbackElement, 'å›ç­”ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
            return;
        }
        userAnswer = selectedChoice.dataset.choiceId;
    } else if (questionType === 'fill') {
        userAnswer = document.getElementById(`answer-${questionId}`).value.trim();
        if (!userAnswer) {
            showLocalMessage(feedbackElement, 'å›ç­”ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
            return;
        }
    } else if (questionType === 'multi_fill') {
        const blankInputs = questionElement.querySelectorAll('input[class*="blank-input"]');
        const answers = [];
        blankInputs.forEach(input => {
            answers.push(input.value.trim());
        });
        userAnswer = answers.join(',');
        
        const allFilled = Array.from(blankInputs).every(input => input.value.trim() !== '');
        if (!allFilled) {
            showLocalMessage(feedbackElement, 'ã™ã¹ã¦ã®ç©ºæ¬„ã«å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
            return;
        }
    }
    
    showLocalMessage(feedbackElement, 'å›ç­”ã‚’é€ä¿¡ä¸­...', 'info');
    
    fetch(`/question/${questionId}/submit/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `answer=${encodeURIComponent(userAnswer)}`
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('å›ç­”é€ä¿¡çµæœ:', data);
        
        if (data.success) {
            showAnswerResult(questionId, data, feedbackElement, explanationElement);
        } else {
            showLocalMessage(feedbackElement, data.message || 'å›ç­”ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showLocalMessage(feedbackElement, 'å›ç­”ã®é€ä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
    });
}

function recordChapterResult(correctCount, totalQuestions) {
    const chapterId = {{ chapter.id }};

    fetch(`/chapters/${chapterId}/record_result/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken'),
        },
        body: `correct=${encodeURIComponent(correctCount)}&total=${encodeURIComponent(totalQuestions)}`
    })
    .then(response => response.json())
    .then(data => {
        console.log('ãƒãƒ£ãƒ—ã‚¿ãƒ¼çµæœè¨˜éŒ²APIãƒ¬ã‚¹ãƒãƒ³ã‚¹:', data);
        if (!data.success) {
            console.warn('çµæœè¨˜éŒ²ã«å¤±æ•—:', data.message);
        }
    })
    .catch(error => {
        console.error('çµæœè¨˜éŒ²ã®é€šä¿¡ã‚¨ãƒ©ãƒ¼:', error);
    });
}


// å›ç­”çµæœã‚’è¡¨ç¤º
function showAnswerResult(questionId, data, feedbackElement, explanationElement) {
    console.log('æ˜¾ç¤ºå›ç­”ç»“æœ:', data);
    
    feedbackElement.innerHTML = '';
    
    // 1. å¤„ç†æ­£ç¡®/é”™è¯¯æ˜¾ç¤º
    if (data.is_correct) {
        showLocalMessage(feedbackElement, 'âœ… å›ç­”æ­£ç¡®ï¼', 'success');
        highlightCorrectAnswer(questionId);
    } else {
        // --- â˜… é‡ç‚¹ä¿®æ”¹åŒºåŸŸï¼šå°±åœ¨è¿™ä¸ª else é‡Œé¢ â˜… ---
        let errorMessage = 'âŒ å›ç­”é”™è¯¯';
        
        // è·å–åç«¯ä¼ æ¥çš„åŸå§‹ç­”æ¡ˆå­—ç¬¦ä¸²
        let rawAnswer = data.correct_answer || '';
        
        // ã€æ ¸å¿ƒä¿®å¤ã€‘ï¼šé˜²æ­¢æµè§ˆå™¨æŠŠ <class 'float'> å½“æˆ HTML æ ‡ç­¾
        // æˆ‘ä»¬æŠŠ < æ¢æˆ &lt; æŠŠ > æ¢æˆ &gt;
        let safeAnswer = rawAnswer.replace(/</g, '&lt;').replace(/>/g, '&gt;');
        
        if (safeAnswer) {
            // ä½¿ç”¨ <code> æ ‡ç­¾åŒ…è£¹ï¼Œè®©ç¼–ç¨‹ä»£ç æ˜¾ç¤ºæ›´æ¸…æ™°
            errorMessage += `<br><strong>æ­£ç¡®ç­”æ¡ˆ:</strong> <code>${safeAnswer}</code>`;
        }
        
        if (data.message) {
            errorMessage += `<br>${data.message}`;
        }
        showLocalMessage(feedbackElement, errorMessage, 'error');
        highlightCorrectAnswer(questionId);
        // --- â˜… ä¿®æ”¹ç»“æŸ â˜… ---
    }

    // 2. æ›´æ–°é¢˜ç›®æ•°æ®é›†ï¼ˆç”¨äºè®¡ç®—è¿›åº¦ï¼‰
    const qEl = document.getElementById(`question-${questionId}`);
    if (qEl) {
        qEl.dataset.userCorrect = data.is_correct ? "1" : "0";
    }

    // 3. å®æ—¶æ›´æ–°é¡µé¢ä¸Šçš„åˆ†æ•°æ•°å­—ï¼ˆè§£å†³â€œå¿…é¡»ç‚¹å®Œäº†æ‰èƒ½çœ‹åˆ†æ•°â€çš„è¿å’Œæ„Ÿï¼‰
    const stats = getQuestionStats(); 
    const scoreSpan = document.getElementById('current-score-display');
    if (scoreSpan) {
        scoreSpan.textContent = stats.accuracy; 
    }
    
    // 4. å…¨é—®æ­£ç¡®æ—¶çš„é€»è¾‘å¤„ç†ï¼ˆè‡ªåŠ¨åœæ­¢è®¡æ—¶ï¼‰
    if (data.is_correct) {
        if (stats.accuracy === 100) {
            console.log('é”æˆå…¨å•æ­£è§£ï¼æ¡ˆå†…ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºã—ã¾ã™...');

            const nextBtnArea = document.getElementById('next-chapter-section');
            if (nextBtnArea) {
                nextBtnArea.style.display = 'block'; 
                nextBtnArea.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            
            if (studyTimer) {
                clearInterval(studyTimer);
                studyTimer = null;
            }
            if (autoSaveInterval) {
                clearInterval(autoSaveInterval);
                autoSaveInterval = null;
            }

            autoSaveStudyTime();
            
            if (typeof storageKey !== 'undefined') {
                localStorage.removeItem(storageKey);
            }

            showMessage('æ­å–œï¼å…¨å•æ­£è§£ã€‚å­¦ç¿’è¨˜éŒ²ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚', 'success');
        }
    }
    
    // æ˜¾ç¤ºè§£æ
    if (data.explanation) {
        showExplanation(explanationElement, data.explanation);
    }
    
    // å¦‚æœå›ç­”æ­£ç¡®ï¼Œç¦ç”¨æŒ‰é’®é˜²æ­¢é‡å¤æäº¤
    if (data.is_correct) {
        disableQuestionActions(questionId);
    }
}

// æ­£è§£ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆè¡¨ç¤ºï¼ˆå¿…è¦ãªã‚‰ä»Šåå†å…·ä½“å®ç°ï¼‰
function highlightCorrectAnswer(questionId) {
    // TODO: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‹ã‚‰æ­£è§£æƒ…å ±ã‚’å—ã‘å–ã£ã¦ãƒã‚¤ãƒ©ã‚¤ãƒˆã™ã‚‹å®Ÿè£…
}

// è§£èª¬ã‚’è¡¨ç¤º
function showExplanation(explanationElement, explanation) {
    const explanationContent = explanationElement.querySelector('.explanation-content');
    if (explanationContent) {
        explanationContent.innerHTML = explanation;
        explanationElement.style.display = 'block';
        
        setTimeout(() => {
            explanationElement.scrollIntoView({ 
                behavior: 'smooth', 
                block: 'nearest' 
            });
        }, 500);
    }
}

// ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚¨ãƒªã‚¢ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
function showLocalMessage(element, message, type) {
    element.innerHTML = '';
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `alert alert-${type}`;
    messageDiv.innerHTML = message;
    
    element.appendChild(messageDiv);
}

// å•é¡Œã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
function disableQuestionActions(questionId) {
    const questionElement = document.getElementById(`question-${questionId}`);
    const submitButton = questionElement.querySelector('.btn-primary');
    const hintButton = questionElement.querySelector('.hint-button');
    
    if (submitButton) {
        submitButton.disabled = true;
        submitButton.textContent = 'å›ç­”æ¸ˆã¿';
        submitButton.style.opacity = '0.6';
    }
    
    if (hintButton) {
        hintButton.disabled = true;
        hintButton.style.opacity = '0.6';
    }
}

// ãƒ’ãƒ³ãƒˆã‚’è¡¨ç¤º
function showHint(questionId) {
    console.log('ãƒ’ãƒ³ãƒˆå–å¾—é–‹å§‹:', questionId);
    
    const feedbackElement = document.getElementById(`feedback-${questionId}`);
    showLocalMessage(feedbackElement, 'ãƒ’ãƒ³ãƒˆã‚’å–å¾—ä¸­...', 'info');
    
    fetch(`/question/${questionId}/hint/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('ãƒ’ãƒ³ãƒˆå–å¾—çµæœ:', data);
        
        if (data.success) {
            feedbackElement.innerHTML = '';
            showHintModal(data.hint, questionId);
        } else {
            showLocalMessage(feedbackElement, data.message || 'ãƒ’ãƒ³ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        }
    })
    .catch(error => {
        console.error('ãƒ’ãƒ³ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        showLocalMessage(feedbackElement, 'ãƒ’ãƒ³ãƒˆã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
    });
}

// ãƒ’ãƒ³ãƒˆè¡¨ç¤ºç”¨ãƒ¢ãƒ¼ãƒ€ãƒ«
function showHintModal(hintText, questionId) {
    const existingModal = document.getElementById('hintModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    const modal = document.createElement('div');
    modal.id = 'hintModal';
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000;
    `;
    
    modal.innerHTML = `
        <div style="
            background: white;
            padding: 2rem;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            position: relative;
        ">
            <div style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 1.5rem;
                padding-bottom: 1rem;
                border-bottom: 2px solid #f0f0f0;
            ">
                <h3 style="
                    margin: 0;
                    color: #2c3e50;
                    display: flex;
                    align-items: center;
                    gap: 0.5rem;
                ">
                    ğŸ’¡ ãƒ’ãƒ³ãƒˆ
                </h3>
                <button onclick="closeHintModal()" style="
                    background: none;
                    border: none;
                    font-size: 1.5rem;
                    cursor: pointer;
                    color: #7f8c8d;
                    padding: 0.5rem;
                    border-radius: 50%;
                    width: 40px;
                    height: 40px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                ">&times;</button>
            </div>
            <div style="
                line-height: 1.6;
                color: #2c3e50;
                font-size: 1.1rem;
            ">
                ${hintText.replace(/\n/g, '<br>')}
            </div>
            <div style="
                margin-top: 2rem;
                display: flex;
                justify-content: flex-end;
                gap: 1rem;
            ">
                <button onclick="closeHintModal()" style="
                    padding: 0.8rem 1.5rem;
                    background: #95a5a6;
                    color: white;
                    border: none;
                    border-radius: 8px;
                    cursor: pointer;
                    font-weight: 600;
                ">
                    é–‰ã˜ã‚‹
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            closeHintModal();
        }
    });
}

// ãƒ’ãƒ³ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
function closeHintModal() {
    const modal = document.getElementById('hintModal');
    if (modal) {
        modal.remove();
    }
}

// â˜… å­¦ç¿’ã‚¬ã‚¤ãƒ‰ã‚’èª­äº†ã¨ã—ã¦ãƒãƒ¼ã‚¯
function markGuideStudied() {
    const chapterId = {{ chapter.id }};

    // ã¾ã æœ€å¾Œã¾ã§èª­ã‚“ã§ã„ãªã„å ´åˆã¯ãƒ–ãƒ­ãƒƒã‚¯
    if (!hasReadStudyGuide) {
        showMessage('å­¦ç¿’ã‚¬ã‚¤ãƒ‰ã‚’æœ€å¾Œã¾ã§èª­ã‚“ã§ã‹ã‚‰ã“ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚', 'error');
        const guideSection = document.getElementById('studyGuideSection');
        if (guideSection) {
            guideSection.scrollIntoView({ behavior: 'smooth' });
        }
        return;
    }
    
    fetch(`/chapter/${chapterId}/mark_guide_studied/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage('å­¦ç¿’ã‚¬ã‚¤ãƒ‰ã‚’èª­äº†ã¨ã—ã¦ãƒãƒ¼ã‚¯ã—ã¾ã—ãŸ', 'success');
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            showMessage('æ“ä½œã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('æ“ä½œä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
    });
}

function calculateCurrentScore() {
    const questions = document.querySelectorAll('.question-item');
    if (questions.length === 0) return 100;

    let correct = 0;
    questions.forEach(q => {
        if (q.dataset.isCorrect === "1") correct++;
    });

    return Math.round((correct / questions.length) * 100);
}

function getQuestionStats() {
    const items = Array.from(document.querySelectorAll('.question-item'));
    const total = items.length;

    // å•é¡ŒãŒãªã„ç« ã¯100%æ‰±ã„
    if (total === 0) return { total: 0, correct: 0, accuracy: 100 };

    let correct = 0;
    items.forEach(el => {
        // data-user-correct="1" ã®ã¨ãã ã‘æ­£è§£æ‰±ã„
        if (el.dataset.userCorrect === "1") correct++;
    });

    const accuracy = Math.round((correct / total) * 100);
    return { total, correct, accuracy };
}

function completeChapter() {
    const chapterId = {{ chapter.id }};
    const stats = getQuestionStats();

    console.log("[completeChapter] stats:", stats); // â† å‹•ä½œç¢ºèªç”¨

    // 100%ã§ãªã‘ã‚Œã°å®Œäº†ã•ã›ãªã„
    if (stats.accuracy < 100) {
        showMessage('ã™ã¹ã¦ã®ç·´ç¿’å•é¡Œã«æ­£è§£ã—ã¦ã‹ã‚‰ãƒãƒ£ãƒ—ã‚¿ãƒ¼ã‚’å®Œäº†ã—ã¦ãã ã•ã„ã€‚', 'error');

        const questionsSection = document.getElementById('questionsSection');
        if (questionsSection) {
            questionsSection.classList.remove('hidden');
            questionsSection.scrollIntoView({ behavior: 'smooth' });
        }
        return;
    }

    // â‘  ã¾ãšã€Œä»Šå›ã®çµæœã€ã‚’è¨˜éŒ²ï¼ˆcorrect/totalï¼‰
    fetch(`/chapters/${chapterId}/record_result/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken'),
        },
        body: `correct=${encodeURIComponent(stats.correct)}&total=${encodeURIComponent(stats.total)}`
    })
    .then(r => r.json())
    .then(data => {
        console.log("record_result:", data);
        // è¨˜éŒ²ãŒå¤±æ•—ã—ã¦ã‚‚å®Œäº†è‡ªä½“ã¯é€²ã‚ãŸã„ã®ã§ã€ã“ã“ã§ã¯æ­¢ã‚ãªã„
    })
    .catch(err => {
        console.warn("record_result error:", err);
    })
    .finally(() => {
        // â‘¡ ãã®ã‚ã¨ãƒãƒ£ãƒ—ã‚¿ãƒ¼å®Œäº†API
        fetch(`/chapter/${chapterId}/complete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(r => r.json())
        .then(data => {
            console.log("complete:", data);
            if (data.success) {
                // å¦‚æœåç«¯è¿”å›äº† level_up ä¸º true
                if (data.level_up) {
                    // å¼¹å‡ºåä¸½çš„å‡çº§å¼¹çª—ï¼Œå¹¶å°†åŸæœ¬çš„è·³è½¬é€»è¾‘æ”¾è¿›å¼¹çª—çš„å…³é—­å›è°ƒä¸­
                    showLevelUpNotification(data.new_level, () => {
                        window.location.href = "{% url 'home' %}";
                    });
                } else {
                    // æ²¡æœ‰å‡çº§ï¼Œæ‰§è¡Œä½ åŸæ¥çš„é€»è¾‘ï¼šæ˜¾ç¤ºæç¤ºå¹¶è‡ªåŠ¨è·³è½¬
                    if (typeof showCustomMessage === 'function') {
                        showCustomMessage(data.message || 'ãƒãƒ£ãƒ—ã‚¿ãƒ¼ã‚’å®Œäº†ã—ã¾ã—ãŸï¼', 'success');
                    } else {
                        alert(data.message || 'ãƒãƒ£ãƒ—ã‚¿ãƒ¼ã‚’å®Œäº†ã—ã¾ã—ãŸï¼');
                    }
                    setTimeout(() => window.location.href = "{% url 'home' %}", 1200);
                }
            } else {
                const msg = data.message || 'å®Œäº†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
                typeof showCustomMessage === 'function' ? showCustomMessage(msg, 'error') : alert(msg);
            }
        })
    });
}

function confirmAndResetProgress(chapterId) {
    // å¢—åŠ äººæ€§åŒ–çš„ç¡®è®¤æç¤º
    const confirmMsg = "ã“ã®ãƒãƒ£ãƒ—ã‚¿ãƒ¼ã®é€²æ—ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ\n\næ³¨æ„ï¼šå­¦ç¿’è¨˜éŒ²ã¯æ¸…ç©ºã•ã‚Œã¾ã™ãŒã€ã€ç´¯è¨ˆå­¦ç¿’æ™‚é–“ã€‘ã¯ä¿æŒã•ã‚Œã¾ã™ã®ã§ã”å®‰å¿ƒãã ã•ã„ã€‚";
    
    if (confirm(confirmMsg)) {
        fetch(`/chapter/${chapterId}/reset/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // é‡ç½®æˆåŠŸååˆ·æ–°é¡µé¢
                window.location.reload();
            } else {
                alert(data.message);
            }
        })
        .catch(err => {
            console.error('Error:', err);
            alert('æ“ä½œå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
        });
    }
}

function showLevelUpNotification(level, onClose) {
    const overlay = document.createElement('div');
    overlay.style = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.85); z-index: 99999;
        display: flex; justify-content: center; align-items: center;
        backdrop-filter: blur(10px);
    `;

    overlay.innerHTML = `
        <div style="background: white; padding: 3rem; border-radius: 30px; text-align: center; 
                    box-shadow: 0 0 50px rgba(255,215,0,0.6); border: 5px solid #FFD700;
                    max-width: 400px; width: 90%; animation: popIn 0.5s cubic-bezier(0.17, 0.89, 0.32, 1.49);">
            <div style="font-size: 5rem; margin-bottom: 1rem;">ğŸŠ</div>
            <h1 style="color: #2c3e50; margin: 0; font-size: 2rem;">LEVEL UP!</h1>
            <p style="color: #7f8c8d; font-size: 1.1rem; margin-top: 10px;">ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼</p>
            <div style="background: linear-gradient(135deg, #FFD700, #FFA500); 
                        color: white; font-size: 3rem; font-weight: bold; 
                        padding: 1rem; border-radius: 20px; margin: 1.5rem 0;">
                Lv. ${level}
            </div>
            <button id="level-up-close-btn" style="
                background: #764ba2; color: white; border: none; padding: 12px 40px; 
                border-radius: 50px; font-size: 1.2rem; cursor: pointer; 
                box-shadow: 0 4px 15px rgba(118,75,162,0.4); transition: transform 0.2s;">
                ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹
            </button>
        </div>
        <style>
            @keyframes popIn {
                from { opacity: 0; transform: scale(0.5); }
                to { opacity: 1; transform: scale(1); }
            }
        </style>
    `;

    document.body.appendChild(overlay);

    // ç‚¹å‡»æŒ‰é’®åæ‰§è¡Œå›è°ƒï¼ˆè·³è½¬é¦–é¡µï¼‰
    document.getElementById('level-up-close-btn').onclick = () => {
        overlay.remove();
        if (onClose) onClose();
    };
}

// é€²æ—ã‚’ãƒªã‚»ãƒƒãƒˆ
function resetProgress() {
    const chapterId = {{ chapter.id }};
    
    if (!confirm('ã“ã®ãƒãƒ£ãƒ—ã‚¿ãƒ¼ã®é€²æ—ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿã™ã¹ã¦ã®å›ç­”è¨˜éŒ²ã¨å­¦ç¿’çŠ¶æ³ãŒå¤±ã‚ã‚Œã¾ã™ã€‚')) {
        return;
    }
    
    fetch(`/chapter/${chapterId}/reset/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage('é€²æ—ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ', 'success');
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            showMessage('ãƒªã‚»ãƒƒãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('ãƒªã‚»ãƒƒãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
    });
}

// Enterã‚­ãƒ¼ã§å›ç­”ã‚’é€ä¿¡ã™ã‚‹è¨­å®š
function setupEnterKeySubmit() {
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Enter') {
            const activeElement = document.activeElement;
            if (activeElement && activeElement.classList.contains('blank-input')) {
                const questionItem = activeElement.closest('.question-item');
                const questionId = questionItem.id.replace('question-', '');
                submitAnswer(questionId);
            }
        }
    });
}

// ä¿å­˜æ¸ˆã¿å›ç­”ã®åˆæœŸè¡¨ç¤ºï¼ˆé€”ä¸­é€€å‡ºã‹ã‚‰ã®å†é–‹ç”¨ï¼‰
function initializeSavedAnswers() {
    const questionItems = document.querySelectorAll('.question-item');
    questionItems.forEach(item => {
        const questionId = item.id.replace('question-', '');
        const questionType = item.dataset.questionType;
        const savedAnswer = item.dataset.userAnswer || '';
        const isCorrect = item.dataset.userCorrect === '1';

        if (!savedAnswer) {
            return;  // æ²¡æœ‰ä¿å­˜çš„ç­”æ¡ˆå°±ä»€ä¹ˆéƒ½ä¸åš
        }

        if (questionType === 'choice') {
            // é€‰æ‹©é¢˜ï¼šæŠŠä¹‹å‰é€‰ä¸­çš„ choice é«˜äº®
            const choices = item.querySelectorAll('.choice-item');
            choices.forEach(choiceEl => {
                if (choiceEl.dataset.choiceId === savedAnswer) {
                    choiceEl.classList.add('selected');
                }
            });
        } else if (questionType === 'fill') {
            // å•ç©ºå¡«ç©ºï¼šæŠŠæ–‡æœ¬å¡«å› input
            const input = item.querySelector(`#answer-${questionId}`);
            if (input) {
                input.value = savedAnswer;
            }
        } else if (questionType === 'multi_fill') {
            // å¤šç©ºå¡«ç©ºï¼šæŒ‰é€—å·åˆ†å‰²ï¼Œä¾æ¬¡å¡«å›å¤šä¸ª input
            const parts = savedAnswer.split(',');
            const inputs = item.querySelectorAll('.multi-blank');
            inputs.forEach((input, index) => {
                if (parts[index]) {
                    input.value = parts[index];
                }
            });
        }

        // å·²ç»æ­£è§£è¿‡çš„é¢˜ï¼Œç»™ä¸€ç‚¹è§†è§‰é«˜äº®ï¼ˆå¯é€‰ï¼‰
        if (isCorrect) {
            item.classList.add('answered-correct');
        }
    });
}


// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºé–¢æ•°ï¼ˆå³ä¸Šæµ®å‹•ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‰
function showMessage(message, type) {
    const existingMessages = document.querySelectorAll('.custom-message');
    existingMessages.forEach(msg => msg.remove());
    
    const messageEl = document.createElement('div');
    messageEl.textContent = message;
    messageEl.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        z-index: 1000;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        max-width: 300px;
        word-wrap: break-word;
    `;
    
    if (type === 'success') {
        messageEl.style.background = 'linear-gradient(135deg, #27ae60, #2ecc71)';
    } else if (type === 'error') {
        messageEl.style.background = 'linear-gradient(135deg, #e74c3c, #c0392b)';
    } else if (type === 'info') {
        messageEl.style.background = 'linear-gradient(135deg, #3498db, #2980b9)';
    }
    
    messageEl.classList.add('custom-message');
    document.body.appendChild(messageEl);
    
    setTimeout(() => {
        messageEl.style.opacity = '0';
        messageEl.style.transform = 'translateX(100px)';
        setTimeout(() => {
            if (messageEl.parentNode) {
                messageEl.parentNode.removeChild(messageEl);
            }
        }, 300);
    }, 3000);
}

// CSRFãƒˆãƒ¼ã‚¯ãƒ³å–å¾—é–¢æ•°
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
