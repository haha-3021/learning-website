{% extends 'base.html' %}
{% load static %}

{% block title %}ç©æœ¨ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« - Pythonå­¦ç¿’ã‚·ã‚¹ãƒ†ãƒ {% endblock %}

{% block extra_css %}
<style>
/* æ—¢å­˜ã®CSSã‚¹ã‚¿ã‚¤ãƒ«ã¯å¤‰æ›´ãªã— */
:root {
    --primary-50: #f0f9ff;
    --primary-100: #e0f2fe;
    --primary-500: #4C56B3;
    --primary-600: #3f4b9e;
    --secondary-50: #f8fafc;
    --secondary-100: #f1f5f9;
    --secondary-500: #64748b;
    --success-50: #f0fdf4;
    --success-500: #22c55e;
    --warning-50: #fffbeb;
    --warning-500: #f59e0b;
    --error-50: #fef2f2;
    --error-500: #ef4444;
    
    /* ç©æœ¨ã‚¿ã‚¤ãƒ—ã‚«ãƒ©ãƒ¼å®šç¾© */
    --block-django: #4C56B3;
    --block-python: #059669;
    --block-data: #dc2626;
    --block-database: #7c3aed;
    --block-admin: #ea580c;
    --block-url: #0891b2;
    --block-template: #db2777;
    --block-calc: #65a30d;
    --block-add: #0d9488;
    --block-delete: #991b1b;
    --block-form: #EC4899;
    --block-view: #8B5CF6;
    --block-database: #475569;
    
    --radius-sm: 8px;
    --radius-md: 12px;
    --radius-lg: 16px;
    --radius-xl: 20px;
}

/* ==================== ãƒšãƒ¼ã‚¸ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ ==================== */

/* === è¶…å¤§ç‰ˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼šå·¦å³2ã‚«ãƒ©ãƒ ãƒ»æœ€å¤§å¹…1800px === */
.building-blocks-page {
    display: flex;
    flex-direction: row;
    align-items: stretch;
    gap: 18px;
    min-height: calc(100vh - 80px);
    height: calc(100vh - 80px);
    padding: 16px 24px 24px;
    background: var(--secondary-50);
    overflow: hidden;
    width: 100%;
    max-width: 1800px;
    margin: 0 auto;
    box-sizing: border-box;
}

/* ==================== ç©æœ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚¨ãƒªã‚¢ï¼ˆå·¦ã‚«ãƒ©ãƒ ï¼‰ ==================== */

/* å·¦ã‚«ãƒ©ãƒ ï¼šç©æœ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼‰ */
.blocks-library-section {
    background: #ffffff;
    border-radius: var(--radius-xl);
    box-shadow: 0 6px 12px -2px rgb(0 0 0 / 0.15);
    flex: 0 0 300px;
    max-width: 320px;
    height: 100%;
    min-height: 0;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.library-header {
    padding: 16px 20px;
    border-bottom: 1px solid var(--secondary-100);
    flex-shrink: 0;
}

.library-header h2 {
    color: var(--primary-500);
    margin: 0 0 6px 0;
    font-size: 1.2rem;
    font-weight: 700;
}

.library-header p {
    color: var(--secondary-500);
    margin: 0;
    font-size: 0.85rem;
    line-height: 1.4;
}

.library-content {
    display: flex;
    flex-direction: column;
    flex: 1 1 auto;
    overflow: hidden;
}

.library-sidebar {
    width: 100%;
    display: flex;
    flex-direction: column;
    flex-shrink: 0;
    overflow: visible;
}

.progress-indicator {
    background: var(--primary-50);
    padding: 10px;
    border-radius: var(--radius-md);
    margin: 10px;
    border-left: 3px solid var(--primary-500);
    flex-shrink: 0;
}

.progress-indicator h4 {
    margin: 0 0 3px 0;
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--primary-500);
}

.progress-indicator p {
    margin: 0;
    font-size: 0.75rem;
    color: var(--secondary-500);
}

.filter-tabs {
    display: flex;
    flex-direction: column;
    padding: 10px;
    gap: 4px;
    flex-shrink: 0;
    overflow: visible;
}

.filter-tab {
    padding: 6px 8px;
    background: none;
    border: none;
    border-left: 3px solid transparent;
    cursor: pointer;
    font-size: 0.75rem;
    font-weight: 500;
    color: var(--secondary-500);
    transition: all 0.2s ease;
    text-align: left;
    border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
    white-space: nowrap;
    overflow: visible;
}

.filter-tab.active {
    color: var(--primary-500);
    border-left-color: var(--primary-500);
    background: var(--primary-50);
}

.blocks-container {
    flex: 1 1 auto;
    overflow-y: auto;
    padding: 12px;
}

.blocks-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 8px;
}

/* ==================== ç©æœ¨ã‚«ãƒ¼ãƒ‰ ==================== */
.block-card {
    background: white;
    border: 1px solid var(--secondary-100);
    border-radius: var(--radius-lg);
    padding: 10px;
    cursor: grab;
    transition: all 0.2s ease;
    position: relative;
    overflow: hidden;
    margin-bottom: 6px;
    height: 110px;
    display: flex;
    flex-direction: column;
}

.block-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 3px;
    height: 100%;
    background: var(--block-color, var(--secondary-500));
}

.block-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 16px -4px rgb(0 0 0 / 0.15);
    border-color: var(--block-color, var(--primary-500));
}

.block-card.locked {
    cursor: not-allowed;
    opacity: 0.7;
    display: none;
}

.block-card.dragging {
    opacity: 0.5;
    transform: scale(0.95);
}

.block-header {
    display: flex;
    align-items: flex-start;
    gap: 8px;
    margin-bottom: 4px;
}

.block-icon {
    width: 26px;
    height: 26px;
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.85rem;
    background: var(--block-color, var(--secondary-500));
    color: white;
    flex-shrink: 0;
}

.block-info {
    flex: 1;
    min-width: 0;
}

.block-name {
    font-weight: 600;
    color: #1f2937;
    margin: 0 0 3px 0;
    font-size: 0.8rem;
    line-height: 1.2;
}

.block-type {
    display: inline-block;
    background: var(--block-color, var(--secondary-500));
    color: white;
    padding: 1px 5px;
    border-radius: 8px;
    font-size: 0.6rem;
    font-weight: 500;
}

.block-description {
    color: var(--secondary-500);
    font-size: 0.65rem;
    line-height: 1.1;
    margin: 4px 0;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    flex: 1;
}

.block-status {
    display: flex;
    align-items: center;
    gap: 3px;
    margin-top: 4px;
    font-size: 0.6rem;
}

/* ==================== ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚¨ãƒªã‚¢ï¼ˆå³ã‚«ãƒ©ãƒ ï¼‰ ==================== */

/* å³ã‚«ãƒ©ãƒ ï¼šã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³ */
.architecture-section {
    background: #ffffff;
    border-radius: var(--radius-xl);
    box-shadow: 0 6px 12px -2px rgb(0 0 0 / 0.15);
    flex: 1 1 auto;
    display: flex;
    flex-direction: column;
    min-height: 0;
    overflow: hidden;
}

.architecture-header {
    padding: 16px 20px;
    border-bottom: 1px solid var(--secondary-100);
    flex-shrink: 0;
}

.architecture-header h1 {
    margin: 0 0 6px 0;
    color: #1f2937;
    font-size: 1.3rem;
    font-weight: 800;
}

.architecture-header p {
    margin: 0 0 12px 0;
    color: var(--secondary-500);
    font-size: 0.9rem;
    line-height: 1.4;
}

.action-bar {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.btn {
    padding: 8px 14px;
    border: none;
    border-radius: var(--radius-md);
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 500;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 6px;
}

.btn-primary {
    background: var(--primary-500);
    color: white;
}

.btn-primary:hover {
    background: var(--primary-600);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(76, 86, 179, 0.3);
}

.btn-secondary {
    background: var(--secondary-100);
    color: var(--secondary-700);
}

.btn-secondary:hover {
    background: var(--secondary-200);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(100, 116, 139, 0.2);
}

/* ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚¨ãƒªã‚¢ */
.canvas-section {
    padding: 20px;
    flex: 1 1 auto;
    display: flex;
    flex-direction: column;
    min-height: 0;
    overflow: hidden;
}

.canvas-container {
    flex: 1 1 auto;
    border: 3px dashed var(--secondary-200);
    border-radius: var(--radius-lg);
    background: 
        linear-gradient(90deg, var(--secondary-100) 1px, transparent 1px),
        linear-gradient(var(--secondary-100) 1px, transparent 1px);
    background-size: 30px 30px;
    position: relative;
    overflow: auto;
    min-height: 800px;
}

#architectureContent {
    width: 100%;
    height: auto;
    min-height: 800px;
    position: relative;
}

/* ==================== æ¥ç¶šç·šã‚¹ã‚¿ã‚¤ãƒ« ==================== */
.connections-container {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 1;
}

.flow-connection {
    stroke: #6B7280;
    stroke-width: 3;
    fill: none;
    marker-end: url(#arrowhead);
}

.flow-connection-dashed {
    stroke-dasharray: 5,5;
    stroke: #9CA3AF;
}

/* ==================== ã‚³ãƒ¼ãƒ‰ãƒ‘ãƒãƒ« ==================== */
.code-panel {
    background: white;
    border-radius: var(--radius-xl);
    box-shadow: 0 8px 15px -3px rgb(0 0 0 / 0.15);
    padding: 24px;
    margin-top: 20px;
    max-height: 400px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.code-panel h3 {
    margin: 0 0 20px 0;
    color: #1f2937;
    font-size: 1.3rem;
    font-weight: 600;
}

.code-editor {
    background: #1e1e1e;
    border-radius: var(--radius-md);
    overflow: hidden;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    flex: 1;
    display: flex;
    flex-direction: column;
}

.code-header {
    background: #2d2d2d;
    padding: 12px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    color: #ccc;
    font-size: 0.9rem;
    flex-shrink: 0;
}

.code-content {
    padding: 20px;
    color: #d4d4d4;
    font-size: 0.9rem;
    line-height: 1.5;
    flex: 1;
    overflow-y: auto;
    max-height: 280px;
}

.code-actions {
    display: flex;
    gap: 12px;
    margin-top: 16px;
    flex-shrink: 0;
}

/* ==================== ãƒ¢ãƒ¼ãƒ€ãƒ« ==================== */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.modal-content {
    background: white;
    border-radius: var(--radius-xl);
    width: 90%;
    max-width: 600px;
    max-height: 80vh;
    overflow: hidden;
    box-shadow: 0 30px 40px -12px rgb(0 0 0 / 0.2);
}

.modal-header {
    padding: 24px 28px;
    border-bottom: 1px solid var(--secondary-100);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3 {
    margin: 0;
    color: #1f2937;
    font-size: 1.4rem;
}

.close-modal {
    background: none;
    border: none;
    font-size: 1.8rem;
    cursor: pointer;
    color: var(--secondary-500);
    padding: 0;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.close-modal:hover {
    background: var(--secondary-100);
    border-radius: 50%;
}

.modal-body {
    padding: 28px;
    max-height: calc(80vh - 100px);
    overflow-y: auto;
}

.block-detail-section {
    margin-bottom: 28px;
}

.block-detail-section h4 {
    margin: 0 0 12px 0;
    color: #374151;
    font-size: 1.2rem;
    font-weight: 600;
}

.block-badge {
    display: inline-block;
    background: var(--primary-100);
    color: var(--primary-700);
    padding: 8px 14px;
    border-radius: 10px;
    font-size: 0.9rem;
    font-weight: 500;
}

.expand-knowledge {
    background: var(--secondary-50);
    padding: 20px;
    border-radius: var(--radius-md);
    font-size: 1rem;
    line-height: 1.6;
}

.no-content {
    color: var(--secondary-500);
    font-style: italic;
}

.loading {
    text-align: center;
    padding: 60px;
    color: var(--secondary-500);
    font-size: 1.1rem;
}

/* ==================== ãƒãƒ¼ãƒ‰ ==================== */
.node {
    position: absolute;
    min-width: 180px;
    min-height: 60px;
    background: #ffffff;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    display: flex; 
    align-items: center; 
    justify-content: center;
    padding: 12px 14px;
    box-shadow: 0 6px 16px -8px rgba(0,0,0,.15);
    font-weight: 600;
    color: #374151;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 0.95rem;
    line-height: 1.3;
}

.node.small { 
    min-width: 150px; 
    min-height: 50px; 
    font-weight: 600; 
    font-size: 0.9rem;
    padding: 10px 12px;
}

.node.tiny { 
    min-width: 140px; 
    min-height: 45px; 
    font-size: .9rem; 
    padding: 8px 10px;
}

.node:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px -8px rgba(0,0,0,.2);
    border-color: var(--primary-500);
}

/* ãƒ‰ãƒ©ãƒƒã‚°é–¢é€£ */
.node.drop-zone {
    border: 2px dashed var(--primary-500);
    background-color: var(--primary-50);
    transform: scale(1.05);
}

.node.drop-allowed {
    border-color: var(--success-500);
    background-color: var(--success-50);
}

.node.drop-not-allowed {
    border-color: var(--error-500);
    background-color: var(--error-50);
}

.assigned-block {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    padding: 4px;
}

.block-info {
    display: flex;
    align-items: center;
    gap: 10px;
}

.block-icon-small {
    width: 24px;
    height: 24px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    color: white;
}

.block-name-small {
    font-size: 0.9rem;
    font-weight: 500;
}

.remove-block {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 1.4rem;
    color: var(--error-500);
    padding: 0;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 6px;
}

.remove-block:hover {
    background: var(--error-50);
}

/* ==================== ãƒ¬ã‚¤ãƒ¤ãƒ¼ ==================== */
.diagram-layer {
    position: absolute;
    border-radius: 14px;
    padding: 16px 16px 26px;
    box-shadow: 0 6px 18px -6px rgba(0,0,0,.2);
    border: 2px solid rgba(0,0,0,.06);
    z-index: 5;
}

.layer-title {
    font-weight: 800;
    margin: 0 0 15px 0;
    font-size: 1.1rem;
    color: #111827;
    opacity: .9;
}

.node-label-sub { 
    font-size: .78rem; 
    color: #6b7280; 
    margin-left: 6px; 
    font-weight: 500; 
}

/* ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚«ãƒ©ãƒ¼ */
.layer-purple { background: rgba(124,58,237,.08); border-color: rgba(124,58,237,.35); }
.layer-green  { background: rgba(16,185,129,.1);  border-color: rgba(16,185,129,.35); }
.layer-cyan   { background: rgba(6,182,212,.1);   border-color: rgba(6,182,212,.35); }
.layer-orange { background: rgba(245,158,11,.12); border-color: rgba(245,158,11,.4); }
.layer-pink   { background: rgba(236,72,153,.1);  border-color: rgba(236,72,153,.35); }
.layer-gray   { background: rgba(107,114,128,0.08); border-color: rgba(107,114,128,0.35); }

/* æ¥ç¶šç·šï¼ˆSVGï¼‰ */
.diagram-svg .arrow { stroke: #6B7280; stroke-width: 3; fill: none; }
.diagram-svg .arrow.dashed { stroke-dasharray: 6 6; stroke: #9CA3AF; }
.diagram-svg text { font-size: 13px; fill: #374151; }

/* ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨HTTPãƒãƒ¼ãƒ‰ä½ç½®èª¿æ•´ï¼ˆä¿æŒï¼‰ */
#userNode {
    left: calc(100% - 200px) !important;
    top: 40px !important;
    width: 180px !important;
    height: 60px !important;
}

#httpReq {
    left: calc(50% - 80px) !important;
    top: 110px !important;
    width: 180px !important;
    height: 55px !important;
}

/* ==================== ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ ==================== */
.blocks-container::-webkit-scrollbar,
.code-content::-webkit-scrollbar,
.canvas-container::-webkit-scrollbar {
    width: 10px;
}

.blocks-container::-webkit-scrollbar-track,
.code-content::-webkit-scrollbar-track,
.canvas-container::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 6px;
}

.blocks-container::-webkit-scrollbar-thumb,
.code-content::-webkit-scrollbar-thumb,
.canvas-container::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 6px;
}

.blocks-container::-webkit-scrollbar-thumb:hover,
.code-content::-webkit-scrollbar-thumb:hover,
.canvas-container::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* ==================== ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– ==================== */
@media (max-width: 1024px) {
    .building-blocks-page {
        flex-direction: column;
        gap: 12px;
        padding: 12px;
        height: auto;
        min-height: calc(100vh - 60px);
    }

    .blocks-library-section {
        flex: 0 0 auto;
        max-width: 100%;
        height: auto;
    }

    .architecture-section {
        flex: 1 1 auto;
    }
}

@media (max-width: 768px) {
    .blocks-grid {
        grid-template-columns: 1fr;
        gap: 6px;
    }

    .block-card {
        height: 100px;
        padding: 8px;
    }

    .btn {
        width: 100%;
        justify-content: center;
    }
}

/* ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ */
.btn-sm {
    padding: 8px 12px;
    font-size: 0.8rem;
}

.text-sm {
    font-size: 0.9rem;
}

.text-xs {
    font-size: 0.8rem;
}

.slide-in {
    animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
    from { opacity: 0; transform: translateY(15px); }
    to   { opacity: 1; transform: translateY(0); }
}

/* === è®©ç§¯æœ¨é¡µé¢â€œè·³å‡ºâ€ base.html çš„ .containerï¼Œé“ºæ»¡æ•´ä¸ªçª—å£å®½åº¦ === */
.blocks-fullwidth-wrapper {
    /* ç”¨ viewport å®½åº¦ï¼Œè€Œä¸æ˜¯å— .container çš„ max-width é™åˆ¶ */
    width: 100vw;

    /* è¿™ä¸€å¥—æ˜¯å¸¸è§çš„ full-bleed æŠ€å·§ï¼Œç”¨äºä»ä¸­é—´çš„ container æ’‘åˆ°å…¨å± */
    position: relative;
    left: 50%;
    right: 50%;
    margin-left: -50vw;
    margin-right: -50vw;

    /* èƒŒæ™¯è·Ÿä½ åŸæ¥çš„é¡µé¢ä¸€æ · */
    background: var(--secondary-50);
}

/* çœŸæ­£çš„å¸ƒå±€å®½åº¦ï¼šæœ€å¤§ 1800pxï¼Œå±…ä¸­ */
.building-blocks-page {
    max-width: 1800px;    /* æƒ³æ›´å¤§å°±æ”¹è¿™é‡Œï¼Œæ¯”å¦‚ 2000 */
    width: 100%;
    margin: 0 auto;

    /* é«˜åº¦ä½ å¯ä»¥æŒ‰éœ€è¦è°ƒï¼Œè¿™é‡Œç¤ºä¾‹ï¼šå‡å»å¯¼èˆª+æ ‡é¢˜åŒºåŸŸçš„é«˜åº¦ */
    min-height: calc(100vh - 160px);

    display: flex;
    flex-direction: row;
    align-items: stretch;
    gap: 18px;
    padding: 16px 24px 24px;
    box-sizing: border-box;
}

.block-detail-section pre,
.block-detail-section code {
    white-space: pre-wrap;   /* æ”¹è¡Œã¨æŠ˜ã‚Šè¿”ã—ä¸¡æ–¹ã‚’æœ‰åŠ¹ã«ã™ã‚‹ */
    word-break: break-word;  /* å˜èªã®é€”ä¸­ã§ã‚‚æŠ˜ã‚Šè¿”ã™ */
}

/* ==================== å®Œæˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ ==================== */
.completion-message {
    background: #ecfdf5;
    border: 1px solid #22c55e;
    border-radius: 16px;
    padding: 16px 20px;
    margin-bottom: 16px;
    text-align: center;
    box-shadow: 0 10px 25px -10px rgba(34,197,94,0.4);
}

.completion-message h3 {
    margin: 0 0 8px 0;
    font-size: 1.2rem;
    color: #166534;
    font-weight: 700;
}

.completion-message p {
    margin: 4px 0;
    font-size: 0.9rem;
    color: #14532d;
}

.completion-message ul {
    list-style: disc;
    margin: 8px 0 0 1.5rem;
    padding: 0;
    text-align: left;
    color: #14532d;
    font-size: 0.9rem;
}

</style>
{% endblock %}

{% block content %}
<div class="blocks-fullwidth-wrapper">
    <div class="building-blocks-page">
        <!-- å·¦å´: ç©æœ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
        <section class="blocks-library-section">
            <div class="library-header">
                <h2>ğŸ§© ç©æœ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª</h2>
                <p>ãƒãƒ£ãƒ—ã‚¿ãƒ¼ã‚’å®Œäº†ã—ã¦æ–°ã—ã„ç©æœ¨ã‚’ç²å¾—ã—ã¾ã—ã‚‡ã†</p>
            </div>

            <div class="library-content">
                <div class="library-sidebar">
                    <div class="progress-indicator">
                        <h4>é€²æ—çŠ¶æ³</h4>
                        <p>ç²å¾—æ¸ˆã¿: <strong>{{ chapters_completed }}</strong>/<strong>{{ total_chapters }}</strong> ãƒãƒ£ãƒ—ã‚¿ãƒ¼</p>
                    </div>

                    <div class="filter-tabs">
                        <button class="filter-tab active" data-filter="all">ã™ã¹ã¦</button>
                        <button class="filter-tab" data-filter="unlocked">åˆ©ç”¨å¯èƒ½</button>
                        <button class="filter-tab" data-filter="locked">ãƒ­ãƒƒã‚¯ä¸­</button>
                    </div>
                </div>

                <div class="blocks-container">
                    <div class="blocks-grid" id="blocksGrid">
                        {% for block in unlocked_blocks %}
                        <div class="block-card unlocked" 
                             data-block-id="{{ block.id }}"
                             data-block-name="{{ block.name }}"
                             data-block-type="{{ block.block_type }}"
                             draggable="true">
                            <div class="block-header">
                                <div class="block-icon" data-block-type="{{ block.block_type }}">
                                    <!-- ã‚¢ã‚¤ã‚³ãƒ³ã¯JavaScriptã§è¨­å®š -->
                                </div>
                                <div class="block-info">
                                    <div class="block-name">{{ block.name }}</div>
                                    <span class="block-type">{{ block.get_block_type_display }}</span>
                                </div>
                            </div>
                            <p class="block-description">{{ block.description }}</p>
                            <div class="block-status unlocked">
                                <span>âœ…</span>
                                <span>åˆ©ç”¨å¯èƒ½</span>
                            </div>
                        </div>
                        {% endfor %}

                        {% for block in locked_blocks %}
                        <div class="block-card locked" 
                             data-block-id="{{ block.id }}"
                             data-block-name="{{ block.name }}"
                             data-block-type="{{ block.block_type }}">
                            <div class="block-header">
                                <div class="block-icon" data-block-type="{{ block.block_type }}">
                                    <!-- ã‚¢ã‚¤ã‚³ãƒ³ã¯JavaScriptã§è¨­å®š -->
                                </div>
                                <div class="block-info">
                                    <div class="block-name">{{ block.name }}</div>
                                    <span class="block-type">{{ block.get_block_type_display }}</span>
                                </div>
                            </div>
                            <p class="block-description">{{ block.description }}</p>
                            <div class="block-status locked">
                                <span>ğŸ”’</span>
                                <span>ãƒ­ãƒƒã‚¯ä¸­</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </section>

        <!-- å³å´: ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³ -->
        <section class="architecture-section">
            <header class="architecture-header">
                <h1>ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³</h1>
                <p>ç©æœ¨ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦ã‚·ã‚¹ãƒ†ãƒ ã‚’æ§‹ç¯‰ã—ã¦ãã ã•ã„ã€‚å„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«ã¯ç‰¹å®šã®ã‚¿ã‚¤ãƒ—ã®ç©æœ¨ã®ã¿é…ç½®ã§ãã¾ã™ã€‚</p>
                
                <div class="action-bar">
                    <button class="btn btn-secondary" onclick="resetArchitecture()">
                        <span>ğŸ”„</span>
                        ãƒªã‚»ãƒƒãƒˆ
                    </button>
                    <button class="btn btn-secondary" onclick="saveArchitecture()">
                        <span>ğŸ’¾</span>
                        ä¿å­˜
                    </button>
                </div>
            </header>

            <!-- ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚¨ãƒªã‚¢ -->
            <section class="canvas-section">
                <!-- â˜… å…¨éƒ¨åŸ‹ã¾ã£ãŸã¨ãã«å‡ºã™ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆåˆæœŸçŠ¶æ…‹ã¯éè¡¨ç¤ºï¼‰ -->
                <div id="completionMessage" class="completion-message" style="display: none;">
                    <h3>ğŸ‰ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ç©æœ¨ãŒå®Œæˆã—ã¾ã—ãŸï¼</h3>
                    <p>ç¾åœ¨ã®ç©æœ¨é…ç½®ã‹ã‚‰åˆ¤æ–­ã™ã‚‹ã¨ï¼Œã‚ãªãŸã¯ã€Œè¨˜ç‰©æœ¬ã€Django ã‚¢ãƒ—ãƒªã®åŸºæœ¬çš„ãªæµã‚Œ</p>
                    <p>ï¼ˆURL â†’ View â†’ Form â†’ Model â†’ Database â†’ Templateï¼‰ã‚’ä¸€é€šã‚Šç†è§£ã§ãã¦ã„ã¾ã™ã€‚</p>
                    <p>æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¨ã—ã¦ï¼Œä¾‹ãˆã°æ¬¡ã®ã‚ˆã†ãªãƒ†ãƒ¼ãƒã«é€²ã‚€ã“ã¨ãŒã§ãã¾ã™ï¼š</p>
                    <ul>
                        <li>Django ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ãƒ»ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½ï¼ˆä¼šå“¡åˆ¶ã‚µã‚¤ãƒˆãƒ»ãƒã‚¤ãƒšãƒ¼ã‚¸ï¼‰</li>
                        <li>ãƒ•ã‚©ãƒ¼ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚„ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºï¼ˆã‚ˆã‚Šãƒªãƒƒãƒãªå…¥åŠ›ç”»é¢ï¼‰</li>
                        <li>æ±ç”¨ã‚¯ãƒ©ã‚¹ãƒ™ãƒ¼ã‚¹ãƒ“ãƒ¥ãƒ¼ã®å¿œç”¨ï¼ˆDetailView / ListView ã®ç™ºå±•çš„ãªä½¿ã„æ–¹ï¼‰</li>
                        <li>Django REST Framework ã‚’ç”¨ã„ãŸ API åŒ–ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã¨åˆ†é›¢ã—ãŸè¨­è¨ˆï¼‰</li>
                        <li>JavaScript ã‚„ Fetch API ã¨çµ„ã¿åˆã‚ã›ãŸéåŒæœŸé€šä¿¡ãƒ»ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªç”»é¢</li>
                    </ul>
                    <p style="margin-top:8px; font-size:0.8rem; color:#16a34a;">
                        â€» ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ï¼Œã™ã¹ã¦ã®æ ã«ç©æœ¨ã‚’é…ç½®ã§ããŸã¨ãã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
                    </p>
                </div>

                <div class="canvas-container" id="canvasContainer">
                    <!-- æ¥ç¶šã‚³ãƒ³ãƒ†ãƒŠ -->
                    <svg class="connections-container" id="connectionsContainer" width="100%" height="100%">
                        <defs>
                            <marker id="arrowhead" markerWidth="12" markerHeight="8" 
                                    refX="10" refY="4" orient="auto">
                                <polygon points="0 0, 12 4, 0 8" fill="#6B7280"/>
                            </marker>
                        </defs>
                    </svg>
                    
                    <!-- ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼ˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰ï¼‰ -->
                    <div id="architectureContent" class="loading">
                        ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³ã‚’èª­ã¿è¾¼ã¿ä¸­...
                    </div>
                </div>
            </section>

            <!-- ã‚³ãƒ¼ãƒ‰ç”Ÿæˆãƒ‘ãƒãƒ« -->
            <section class="code-panel" id="codePanel" style="display: none;">
                <h3>ğŸ“„ ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰</h3>
                <div class="code-editor">
                    <div class="code-header">
                        <span>generated_code.py</span>
                        <button class="btn btn-primary btn-sm" onclick="copyGeneratedCode()">
                            ã‚³ãƒ”ãƒ¼
                        </button>
                    </div>
                    <div class="code-content" id="generatedCode">
                        # ã‚³ãƒ¼ãƒ‰ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™
                    </div>
                </div>
                <div class="code-actions">
                    <button class="btn btn-secondary" onclick="downloadCode()">
                        ğŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                    </button>
                    <button class="btn btn-secondary" onclick="closeCodePanel()">
                        é–‰ã˜ã‚‹
                    </button>
                </div>
            </section>
        </section>
    </div>
</div>

<!-- ç©æœ¨è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal-overlay" id="blockDetailModal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalBlockName">ç©æœ¨è©³ç´°</h3>
            <button class="close-modal" id="closeModalBtn">Ã—</button>
        </div>
        <div class="modal-body" id="modalBody">
            <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // ==============================
    // ç©æœ¨ã®è‰²ãƒ»ã‚¢ã‚¤ã‚³ãƒ³å®šç¾©
    // ==============================
    const BLOCK_COLORS = {
        'Django_basic': '#4C56B3',
        'python_basic': '#059669',
        'data_model': '#dc2626',
        'database': '#7c3aed',
        'admin': '#ea580c',
        'list_display': '#0891b2',
        'url': '#0891b2',
        'template': '#db2777',
        'calculation': '#65a30d',
        'add_function': '#0d9488',
        'delete_function': '#991b1b',
        'form': '#EC4899',
        'view': '#8B5CF6'
    };

    const BLOCK_ICONS = {
        'Django_basic': 'ğŸ”·',
        'python_basic': 'ğŸ',
        'data_model': 'ğŸ“Š',
        'database': 'ğŸ—ƒï¸',
        'admin': 'âš™ï¸',
        'list_display': 'ğŸ“‹',
        'url': 'ğŸ”—',
        'template': 'ğŸ“„',
        'calculation': 'ğŸ§®',
        'add_function': 'â•',
        'delete_function': 'â–',
        'form': 'ğŸ“',
        'view': 'ğŸ‘ï¸'
    };

    // ==============================
    //  ãƒãƒ¼ãƒ‰ã”ã¨ã®ã€Œç©æœ¨åãƒ«ãƒ¼ãƒ«ã€
    // ==============================
    const NODE_BLOCK_NAME_RULES = {
        // ===== URLãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°å±¤ - urls.py =====
        url_router: [
            'URLãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒãƒ£',
            'url_router',
            'urls.py ãƒ«ãƒ¼ãƒˆ'
        ],
        url_items: [
            '/items/',
            'items_list_url',
            'ç‰©å“ä¸€è¦§URL',
            '/items/ ç‰©å“ä¸€è¦§' 
        ],
        url_crud: [
            '/items/add',
            '/items/edit',
            '/items/delete',
            'item_create_url',
            'item_update_url',
            'item_delete_url',
            'ç‰©å“CRUD URL',
            '/items/add|edit|delete/ ç‰©å“CRUDæ“ä½œ'
        ],
        url_categories: [
            '/categories/',
            'categories_url',
            'ã‚«ãƒ†ã‚´ãƒªãƒ¼ä¸€è¦§URL',
            '/categories/ ã‚«ãƒ†ã‚´ãƒªãƒ¼ç®¡ç†'
        ],

        // ===== ãƒ“ãƒ¥ãƒ¼ãƒ¬ã‚¤ãƒ¤ãƒ¼ - views.py =====
        item_list_view: [
            'ItemListView',
            'ItemListView ç‰©å“ä¸€è¦§è¡¨ç¤º'
        ],
        item_crud_views: [
            'ItemCreateView',
            'ItemUpdateView',
            'ItemDeleteView',
            'ItemCRUDView',
            'ItemCreate/Update/DeleteView',
            'ç‰©å“CRUDæ“ä½œ'
        ],
        category_views: [
            'CategoryListView'
        ],
        get_context: [
            'get_context_data',
            'get_context_data() çµ±è¨ˆæƒ…å ±è¨ˆç®—'
        ],
        form_valid: [
            'form_valid',
            'form_valid() ãƒ•ã‚©ãƒ¼ãƒ æ¤œè¨¼ã¨ä¿å­˜'
        ],
        delete_method: [
            'delete',
            'delete() å‰Šé™¤å‡¦ç†'
        ],

        // ===== ãƒ•ã‚©ãƒ¼ãƒ ãƒ¬ã‚¤ãƒ¤ãƒ¼ - forms.py =====
        item_form: [
            'ItemForm'
        ],

        // ===== ãƒ¢ãƒ‡ãƒ«ãƒ¬ã‚¤ãƒ¤ãƒ¼ - models.py =====
        item_model: [
            'Item',
            'Itemãƒ¢ãƒ‡ãƒ«'
        ],

        // ===== ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å±¤ =====
        database: [
            'SQLite',
            'PostgreSQL',
            'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹',
            'SQLite/PostgreSQL ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹',
            'SQLiteãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹'
        ],

        // ===== ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ¬ã‚¤ãƒ¤ãƒ¼ - templates =====
        tpl_main: [
            'base.html'
        ],
        tpl_stats: [
            'item_list.html'
        ],
        tpl_form: [
            'item_form.html'
        ],
        tpl_delete: [
            'item_confirm_delete.html'
        ],
        tpl_category: [
            'category_list.html'
        ],
        tpl_category_form: [
            'category_form.html'
        ],
        tpl_category_delete: [
            'category_confirm_delete.html'
        ]
    };

    // ç©æœ¨åã®æ­£è¦åŒ–ï¼šå¤§æ–‡å­—å°æ–‡å­—ãƒ»ä½™åˆ†ãªé£¾ã‚Šã‚’å¸åã—ã¦ãƒãƒƒãƒã—ã‚„ã™ãã™ã‚‹
    function normalizeBlockName(name) {
        if (!name) return '';
        return name
            .toString()
            .toLowerCase()
            .replace(/ï¼ˆ.*?ï¼‰/g, '')      // å…¨è§’ã‚«ãƒƒã‚³å†…
            .replace(/\(.*?\)/g, '')      // åŠè§’ã‚«ãƒƒã‚³å†…
            .replace(/ãƒ“ãƒ¥ãƒ¼|view|ãƒ–ãƒ­ãƒƒã‚¯|block/g, '') // ã€Œã€œãƒ“ãƒ¥ãƒ¼ã€ã€Œã€œãƒ–ãƒ­ãƒƒã‚¯ã€ãªã©ã‚’å‰Šã‚‹
            .replace(/\s+/g, '');         // ç©ºç™½ã‚’å…¨éƒ¨æ¶ˆã™
    }

    // ã“ã®ç©æœ¨ã¯ã“ã® node ã«å…¥ã£ã¦ã‚ˆã„ã‹ï¼Ÿã‚¿ã‚¤ãƒ—ï¼‹åå‰ã§åˆ¤å®š
    function isBlockAllowedForNode(blockEl, nodeEl) {
        if (!blockEl || !nodeEl) return false;

        // â‘  ã¾ãšã‚¿ã‚¤ãƒ—ï¼ˆview/url/template...ï¼‰ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆå¾“æ¥é€šã‚Šï¼‰
        let allowedTypes = [];
        try {
            allowedTypes = JSON.parse(nodeEl.dataset.allowedTypes || '[]');
        } catch (e) {
            allowedTypes = [];
        }
        const blockType = blockEl.dataset.blockType;

        if (allowedTypes.length > 0 && !allowedTypes.includes(blockType)) {
            return false;
        }

        // â‘¡ åå‰ãƒ«ãƒ¼ãƒ«ï¼ˆNODE_BLOCK_NAME_RULESï¼‰ã‚’ãƒã‚§ãƒƒã‚¯
        const nodeId    = nodeEl.id;
        const ruleNames = NODE_BLOCK_NAME_RULES[nodeId];

        // ã“ã® node ã«åå‰ãƒ«ãƒ¼ãƒ«ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆ â†’ ã‚¿ã‚¤ãƒ—ã ã‘ã§ OKï¼ˆæ—¢å­˜æŒ™å‹•ã‚’ç¶­æŒï¼‰
        if (!ruleNames || ruleNames.length === 0) {
            return true;
        }

        const blockNameNorm = normalizeBlockName(blockEl.dataset.blockName);

        // ã©ã‚Œã‹ 1 å€‹ã§ã‚‚ä¸€è‡´ã—ãŸã‚‰ OK
        return ruleNames.some(ruleName => {
            return blockNameNorm === normalizeBlockName(ruleName);
        });
    }

    // ==============================
    //  ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    // ==============================
    let architectureData = null;
    let draggedBlock = null;
    let slotAssignments = {};
    const nodeOriginalContent = {};

    document.addEventListener('DOMContentLoaded', function() {
        console.log('ãƒšãƒ¼ã‚¸åˆæœŸåŒ–ã‚’é–‹å§‹...');
        initializePage();
    });

    async function initializePage() {
        try {
            setupBlockColorsAndIcons();
            initializeDragAndDrop();
            await loadArchitectureData();
            setupFilterTabs();
            setupBlockClickEvents();
            setupModalEvents();
            console.log('ãƒšãƒ¼ã‚¸åˆæœŸåŒ–å®Œäº†');
            setTimeout(() => { drawSimplifiedConnections(); }, 500);
        } catch (error) {
            console.error('ãƒšãƒ¼ã‚¸åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
            showMessage('ãƒšãƒ¼ã‚¸ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
        }
    }

    // ==============================
    //  ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³ã®èª­ã¿è¾¼ã¿
    // ==============================
    async function loadArchitectureData() {
        try {
            console.log('ãƒ­ãƒ¼ã‚«ãƒ«ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰ä¸­...');

            // ã¾ãšå›ºå®šãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã§å›³ã‚’æç”»
            renderArchitecture();

            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰å‰å›ä¿å­˜ã—ãŸç©æœ¨ã®é…ç½®ã‚’å–å¾—
            const saved = localStorage.getItem('architecture_slot_assignments_v1');
            if (saved) {
                try {
                    slotAssignments = JSON.parse(saved);
                    console.log('ä¿å­˜æ¸ˆã¿ã‚¹ãƒ­ãƒƒãƒˆå‰²ã‚Šå½“ã¦ã‚’é©ç”¨ã—ã¾ã™:', slotAssignments);
                    applySavedAssignments(slotAssignments);
                } catch (e) {
                    console.error('ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', e);
                    slotAssignments = {};
                }
            } else {
                console.log('ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ã•ã‚ŒãŸç©æœ¨é…ç½®ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚');
                slotAssignments = {};
            }

            // çŸ¢å°ã‚’æç”»
            drawSimplifiedConnections();
        } catch (error) {
            console.error('ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
            showMessage('ãƒšãƒ¼ã‚¸ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
        }
    }

    // ==============================
//  ä¿å­˜æ¸ˆã¿å‰²ã‚Šå½“ã¦ã®é©ç”¨
// ==============================
function applySavedAssignments(assignments) {
    if (!assignments) return;

    Object.keys(assignments).forEach(componentId => {
        const info = assignments[componentId];
        if (!info) return;

        let blockId   = info.block_id;
        const blockName = info.block_name;

        // block_id ãŒç„¡ã„å ´åˆã¯åå‰ã‹ã‚‰æ¢ã™
        if (!blockId && blockName) {
            document.querySelectorAll('.block-card.unlocked').forEach(card => {
                const nameEl = card.querySelector('.block-name');
                const name   = nameEl ? nameEl.textContent.trim() : '';
                if (name === blockName) {
                    blockId = card.dataset.blockId;
                }
            });
        }

        if (!blockId || !blockName) return;

        // æ—¢å­˜ã®è¦‹ãŸç›®æ›´æ–°é–¢æ•°ã‚’ä½¿ã£ã¦ãƒãƒ¼ãƒ‰ã«åæ˜ 
        updateComponentVisual(componentId, blockId, blockName);
    });

    // â˜… ãƒšãƒ¼ã‚¸åŠ è½½æ—¶å¦‚æœæœ¬æ¥å°±éƒ½å¡«æ»¡ï¼Œä¹Ÿæ˜¾ç¤ºæç¤º
    checkAllSlotsFilledAndShowSummary();
}


    // ==============================
    //  ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³ã®æç”»
    // ==============================
    function renderArchitecture() {
        const container = document.getElementById('architectureContent');
        const svg = document.getElementById('connectionsContainer');
        if (!container || !svg) return;

        container.classList.remove('loading');
        container.innerHTML = '';

        // ç”»å¸ƒå¹…
        const CANVAS_W = 1550;
        const marginX = 60;

        // ===== ä¸Šéƒ¨ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼ & HTTP =====
        const userNode = addFloatingNode(
            container,
            'userNode',
            'ãƒ¦ãƒ¼ã‚¶ãƒ¼/ãƒ–ãƒ©ã‚¦ã‚¶',
            { x: CANVAS_W - 220, y: 40, w: 190, h: 60 }
        );

        const httpNode = addFloatingNode(
            container,
            'httpReq',
            'HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆ',
            { x: CANVAS_W / 2 - 90, y: 120, w: 180, h: 55 }
        );

        // ===== URL ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°å±¤ =====
        const urlLayer = addLayer(
            container,
            'urlLayer',
            'URLãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°å±¤ - urls.py',
            'layer-green',
            {x: marginX,y: 200,w: 1020,h: 170}
        );

        // 1 è¡Œã« 4 ã¤ä¸¦ã¹ã¦ã€é‡ãªã‚Šï¼†ã¯ã¿å‡ºã—ã‚’è§£æ¶ˆ
        addNode(
            urlLayer,
            'url_router',
            'URLãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒãƒ£',
            { x: 50, y: 55, w: 220, h: 70 },
            ['url']
        );

        addNode(
            urlLayer,
            'url_items',
            '/items/<br>ç‰©å“ä¸€è¦§',
            { x: 300, y: 55, w: 200, h: 70 },
            ['url']
        );

        addNode(
            urlLayer,
            'url_crud',
            '/items/add|edit|delete/<br>ç‰©å“CRUDæ“ä½œ',
            { x: 530, y: 55, w: 260, h: 70 },
            ['url']
        );

        // â˜… /categories/ ã‚«ãƒ†ã‚´ãƒªãƒ¼ç®¡ç†
        addNode(
            urlLayer,
            'url_categories',
            '/categories/<br>ã‚«ãƒ†ã‚´ãƒªãƒ¼ç®¡ç†',
            { x: 810, y: 55, w: 200, h: 70 },
            ['url']
        );

        // ===== ãƒ“ãƒ¥ãƒ¼ãƒ¬ã‚¤ãƒ¤ãƒ¼ =====
        const viewLayer = addLayer(
            container,
            'viewLayer',
            'ãƒ“ãƒ¥ãƒ¼ãƒ¬ã‚¤ãƒ¤ãƒ¼ - views.py',
            'layer-purple',
            { x: marginX, y: 390, w: 950, h: 270 }
        );

        // 1æ®µç›®ï¼š3 ã¤æ¨ªä¸¦ã³
        addNode(
            viewLayer,
            'item_list_view',
            'ItemListView<br>ç‰©å“ä¸€è¦§è¡¨ç¤º',
            { x: 80, y: 70, w: 230, h: 80 },
            ['view']
        );

        addNode(
            viewLayer,
            'item_crud_views',
            'ItemCreate/Update/DeleteView<br>ç‰©å“CRUDæ“ä½œ',
            { x: 360, y: 70, w: 260, h: 80 },
            ['view']
        );

        addNode(
            viewLayer,
            'category_views',
            'CategoryListView<br>ã‚«ãƒ†ã‚´ãƒªãƒ¼ä¸€è¦§',
            { x: 660, y: 70, w: 220, h: 80 },
            ['view']
        );

        // 2æ®µç›®ï¼šè£œåŠ©ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å°‘ã—ä¸‹ã«ãšã‚‰ã—ã¦æ•´åˆ—
        addNode(
            viewLayer,
            'get_context',
            'get_context_data()<br>çµ±è¨ˆæƒ…å ±è¨ˆç®—',
            { x: 80, y: 175, w: 230, h: 65, cls: 'small' },   // ItemListView ã®çœŸä¸‹
            ['view']
        );

        addNode(
            viewLayer,
            'form_valid',
            'form_valid()<br>ãƒ•ã‚©ãƒ¼ãƒ æ¤œè¨¼ã¨ä¿å­˜',
            { x: 360, y: 175, w: 260, h: 65, cls: 'small' },  // CRUD ãƒ“ãƒ¥ãƒ¼ã®çœŸä¸‹
            ['view']
        );

        addNode(
            viewLayer,
            'delete_method',
            'delete()<br>å‰Šé™¤å‡¦ç†',
            { x: 660, y: 175, w: 220, h: 65, cls: 'small' },  // CategoryListView ã®ä¸‹å´
            ['view']
        );

        // ===== ãƒ•ã‚©ãƒ¼ãƒ ãƒ¬ã‚¤ãƒ¤ãƒ¼ =====
        const formLayer = addLayer(
            container,
            'formLayer',
            'ãƒ•ã‚©ãƒ¼ãƒ ãƒ¬ã‚¤ãƒ¤ãƒ¼ - forms.py',
            'layer-pink',
            { x: marginX, y: 690, w: 430, h: 150 }
        );

        addNode(
            formLayer,
            'item_form',
            'ItemForm<br>ç‰©å“ãƒ•ã‚©ãƒ¼ãƒ ',
            { x: 110, y: 55, w: 260, h: 80 },
            ['form']
        );

        // ===== ãƒ¢ãƒ‡ãƒ«ãƒ¬ã‚¤ãƒ¤ãƒ¼ =====
        const modelLayer = addLayer(
            container,
            'modelLayer',
            'ãƒ¢ãƒ‡ãƒ«ãƒ¬ã‚¤ãƒ¤ãƒ¼ - models.py',
            'layer-gray',
            { x: 550, y: 690, w: 430, h: 150 }
        );

        addNode(
            modelLayer,
            'item_model',
            'Itemãƒ¢ãƒ‡ãƒ«<br>ç‰©å“ãƒ‡ãƒ¼ã‚¿æ§‹é€ ',
            { x: 110, y: 55, w: 260, h: 80 },
            ['data_model']
        );

        // ===== ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å±¤ =====
        const databaseLayer = addLayer(
            container,
            'databaseLayer',
            'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å±¤',
            'layer-orange',
            { x: 550, y: 860, w: 430, h: 130 }
        );

        addNode(
            databaseLayer,
            'database',
            'SQLite/PostgreSQL<br>ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹',
            { x: 110, y: 40, w: 260, h: 70 },
            ['database']
        );

        // ===== ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆå³å´ã®ç¸¦é•·ã‚¨ãƒªã‚¢ï¼‰ =====
        const tplLayer = addLayer(
            container,
            'tplLayer',
            'ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ¬ã‚¤ãƒ¤ãƒ¼ - templates',
            'layer-cyan',
            { x: 1090, y: 400, w: 420, h: 790 }
        );

        addNode(
            tplLayer,
            'tpl_main',
            'base.html<br>ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ',
            { x: 60, y: 70, w: 310, h: 70 },
            ['template']
        );

        addNode(
            tplLayer,
            'tpl_stats',
            'item_list.html<br>ç‰©å“ä¸€è¦§ç”»é¢',
            { x: 60, y: 160, w: 310, h: 70 },
            ['template']
        );

        addNode(
            tplLayer,
            'tpl_form',
            'item_form.html<br>ç‰©å“ç™»éŒ²/ç·¨é›†',
            { x: 60, y: 250, w: 310, h: 70 },
            ['template']
        );

        addNode(
            tplLayer,
            'tpl_delete',
            'item_confirm_delete.html<br>å‰Šé™¤ç¢ºèª',
            { x: 60, y: 340, w: 310, h: 70 },
            ['template']
        );

        addNode(
            tplLayer,
            'tpl_category',
            'category_list.html<br>ã‚«ãƒ†ã‚´ãƒªãƒ¼ç®¡ç†',
            { x: 60, y: 430, w: 310, h: 70 },
            ['template']
        );

        addNode(
            tplLayer,
            'tpl_category_form',
            'category_form.html<br>ã‚«ãƒ†ã‚´ãƒªãƒ¼ç™»éŒ²/ç·¨é›†',
            { x: 60, y: 520, w: 310, h: 70 },
            ['template']
        );

        addNode(
            tplLayer,
            'tpl_category_delete',
            'category_confirm_delete.html<br>ã‚«ãƒ†ã‚´ãƒªãƒ¼å‰Šé™¤ç¢ºèª',
            { x: 60, y: 610, w: 310, h: 70 },
            ['template']
        );

        // ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³å†è¨­å®š
        setTimeout(() => {
            initializeComponentDropZones();
        }, 100);

        // ç·šã®æç”»
        drawSimplifiedConnections();
    }

    // ==============================
    //  æ¥ç¶šç·šã®æç”»
    // ==============================
    function drawSimplifiedConnections() {
        const svg = document.getElementById('connectionsContainer');
        if (!svg) {
            console.error('connectionsContainer not found');
            return;
        }
        
        svg.classList.add('diagram-svg');
        
        while (svg.childNodes.length > 1) {
            if (svg.lastChild.tagName !== 'defs') {
                svg.removeChild(svg.lastChild);
            } else {
                break;
            }
        }

        if (!svg.querySelector('defs')) {
            const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
            const marker = document.createElementNS('http://www.w3.org/2000/svg', 'marker');
            marker.setAttribute('id', 'arrowhead');
            marker.setAttribute('markerWidth', '12');
            marker.setAttribute('markerHeight', '8');
            marker.setAttribute('refX', '10');
            marker.setAttribute('refY', '4');
            marker.setAttribute('orient', 'auto');
            
            const polygon = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
            polygon.setAttribute('points', '0 0, 12 4, 0 8');
            polygon.setAttribute('fill', '#6B7280');
            
            marker.appendChild(polygon);
            defs.appendChild(marker);
            svg.appendChild(defs);
        }

        function line(a, b, label=null, dashed=false) {
            const p = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            p.setAttribute('d', `M ${a.x} ${a.y} L ${b.x} ${b.y}`);
            p.setAttribute('class', `arrow${dashed?' dashed':''}`);
            p.setAttribute('marker-end', 'url(#arrowhead)');
            p.setAttribute('stroke', dashed ? '#9CA3AF' : '#6B7280');
            p.setAttribute('stroke-width', '3');
            if (dashed) {
                p.setAttribute('stroke-dasharray', '6,6');
            }
            svg.appendChild(p);
            
            if (label) {
                const midx = (a.x+b.x)/2, midy = (a.y+b.y)/2 - 8;
                const t = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                t.setAttribute('x', midx);
                t.setAttribute('y', midy);
                t.setAttribute('text-anchor', 'middle');
                t.setAttribute('fill', '#374151');
                t.setAttribute('font-size', '13px');
                t.textContent = label;
                svg.appendChild(t);
            }
        }

        const user = document.getElementById('userNode');
        const http = document.getElementById('httpReq');
        const urlRouter = document.getElementById('url_router');
        const urlItems = document.getElementById('url_items');
        const urlCrud = document.getElementById('url_crud');
        const itemListView = document.getElementById('item_list_view');
        const itemCrudViews = document.getElementById('item_crud_views');
        const itemForm = document.getElementById('item_form');
        const itemModel = document.getElementById('item_model');
        const database = document.getElementById('database');
        const itemListTemplate = document.getElementById('tpl_stats');

        if (user && http) line(leftCenterOf(user), topCenterOf(http), 'ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œ');
        if (http && urlRouter) line(bottomCenterOf(http), topCenterOf(urlRouter), 'HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆ');
        
        if (urlItems && itemListView) line(bottomCenterOf(urlItems), topCenterOf(itemListView), 'GET /items/');
        if (urlCrud && itemCrudViews) line(bottomCenterOf(urlCrud), topCenterOf(itemCrudViews), 'CRUDæ“ä½œ');
        
        if (itemCrudViews && itemForm) line(bottomCenterOf(itemCrudViews), topCenterOf(itemForm), 'ãƒ•ã‚©ãƒ¼ãƒ å‡¦ç†');
        if (itemCrudViews && itemModel) line(bottomCenterOf(itemCrudViews), topCenterOf(itemModel), 'ãƒ‡ãƒ¼ã‚¿æ“ä½œ');
        
        if (itemModel && database) line(bottomCenterOf(itemModel), topCenterOf(database), 'ORMæ“ä½œ');
        
        if (itemListView && itemListTemplate) {
            line(rightCenterOf(itemListView), leftCenterOf(itemListTemplate), 'ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°');
        }
        
        if (itemListTemplate && user) {
            line(
                topCenterOf(itemListTemplate),
                bottomCenterOf(user),
                'HTMLãƒ¬ã‚¹ãƒãƒ³ã‚¹',
                true
            );
        }
        
        console.log('æ¥ç¶šç·šã®æç”»ãŒå®Œäº†ã—ã¾ã—ãŸã€‚åˆè¨ˆ', svg.querySelectorAll('path').length, 'æœ¬ã®ç·šã‚’æç”»ã—ã¾ã—ãŸã€‚');
    }

    // ==============================
    //  ãƒãƒ¼ãƒ‰ãƒ»ãƒ¬ã‚¤ãƒ¤ãƒ¼ç”Ÿæˆç³»
    // ==============================
    function addLayer(container, id, title, colorCls, bbox) {
        const el = document.createElement('div');
        el.className = `diagram-layer ${colorCls}`;
        el.id = id;
        el.style.left = `${bbox.x}px`;
        el.style.top  = `${bbox.y}px`;
        el.style.width = `${bbox.w}px`;
        el.style.height = `${bbox.h}px`;
        el.innerHTML = `<div class="layer-title">${title}</div>`;
        container.appendChild(el);
        return el;
    }

    function addFloatingNode(container, id, text, opts) {
        const el = document.createElement('div');
        el.className = `node ${opts.extraCls || ''}`;
        el.id = id;
        el.style.left = `${opts.x}px`;
        el.style.top  = `${opts.y}px`;
        el.style.width = `${opts.w}px`;
        el.style.height = `${opts.h}px`;
        el.style.zIndex = 20;
        el.innerHTML = text;
        
        if (id === 'httpReq') {
            el.setAttribute('data-component-id', id);
            el.setAttribute('data-component-type', 'node');
            el.setAttribute('data-allowed-types', JSON.stringify(['url']));
            nodeOriginalContent[id] = el.innerHTML;
        }
        
        container.appendChild(el);
        return el;
    }

    function addNode(parent, id, text, opts, allowedTypes = []) {
        const el = document.createElement('div');
        el.className = `node ${opts.cls || ''}`;
        el.id = id;
        el.style.left = `${opts.x}px`;
        el.style.top  = `${opts.y}px`;
        if (opts.w) el.style.width = `${opts.w}px`;
        if (opts.h) el.style.height = `${opts.h}px`;
        el.innerHTML = text.replace(/\\n/g, '<br/>');
        
        el.setAttribute('data-component-id', id);
        el.setAttribute('data-component-type', 'node');
        el.setAttribute('data-allowed-types', JSON.stringify(allowedTypes));
        nodeOriginalContent[id] = el.innerHTML;
        
        parent.appendChild(el);
        return el;
    }

    // ==============================
    //  ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—
    // ==============================
    function initializeComponentDropZones() {
        const dropZones = document.querySelectorAll('.node');
        console.log(`${dropZones.length} å€‹ã®ãƒ‰ãƒ­ãƒƒãƒ—ã‚¨ãƒªã‚¢ã‚’è¦‹ã¤ã‘ã¾ã—ãŸ`);
        
        dropZones.forEach(zone => {
            if (zone.id === 'userNode' || zone.id === 'httpReq') {
                return;
            }

            zone.removeEventListener('dragover', handleDragOver);
            zone.removeEventListener('dragenter', handleDragEnter);
            zone.removeEventListener('dragleave', handleDragLeave);
            zone.removeEventListener('drop', handleDrop);
            
            zone.addEventListener('dragover', handleDragOver);
            zone.addEventListener('dragenter', handleDragEnter);
            zone.addEventListener('dragleave', handleDragLeave);
            zone.addEventListener('drop', handleDrop);
        });
    }

    function handleDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        return false;
    }

    // â˜… ã‚¿ã‚¤ãƒ—ï¼‹åå‰ã§åˆ¤å®šã™ã‚‹ã‚ˆã†ã«å¤‰æ›´
    function handleDragEnter(e) {
        e.preventDefault();
        if (draggedBlock) {
            if (isBlockAllowedForNode(draggedBlock, this)) {
                this.classList.add('drop-allowed');
            } else {
                this.classList.add('drop-not-allowed');
            }
        }
    }

    function handleDragLeave(e) {
        if (!this.contains(e.relatedTarget)) {
            this.classList.remove('drop-allowed', 'drop-not-allowed');
        }
    }

    // â˜… Drop æ™‚ã‚‚ isBlockAllowedForNode ã§æœ€çµ‚ãƒã‚§ãƒƒã‚¯
    async function handleDrop(e) {
        e.preventDefault();
        this.classList.remove('drop-allowed', 'drop-not-allowed');
        
        if (!draggedBlock) {
            console.log('ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®ãƒ–ãƒ­ãƒƒã‚¯ãŒã‚ã‚Šã¾ã›ã‚“');
            return;
        }
        
        const componentId = this.dataset.componentId;
        const blockId     = draggedBlock.dataset.blockId;
        const blockName   = draggedBlock.dataset.blockName;
        
        try {
            console.log('ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«ç©æœ¨ã‚’é…ç½®:', {
                componentId, blockId, blockName
            });

            // æœ€çµ‚ãƒã‚§ãƒƒã‚¯ï¼šã‚¿ã‚¤ãƒ—ï¼‹åå‰
            if (!isBlockAllowedForNode(draggedBlock, this)) {
                const componentName = (this.textContent || 'ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ').trim();
                alert(
                    `ã“ã®ç©æœ¨ã€Œ${blockName}ã€ã¯ã€Œ${componentName}ã€ã«ã¯é…ç½®ã§ãã¾ã›ã‚“ã€‚\n` +
                    `å¯¾å¿œã—ã¦ã„ã‚‹å ´æ‰€ã«ã®ã¿é…ç½®ã§ãã¾ã™ã€‚`
                );
                return;
            }
            
            await assignBlockToComponent(componentId, blockId, blockName, 'node');
        } catch (error) {
            console.error('ç©æœ¨é…ç½®ã‚¨ãƒ©ãƒ¼:', error);
            showMessage('ç©æœ¨ã®é…ç½®ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        }
    }

    function initializeDragAndDrop() {
        console.log('ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã‚’åˆæœŸåŒ–...');
    
        const draggableBlocks = document.querySelectorAll('.block-card.unlocked');
        draggableBlocks.forEach(block => {
            block.removeEventListener('dragstart', handleBlockDragStart);
            block.removeEventListener('dragend', handleBlockDragEnd);
        
            block.addEventListener('dragstart', handleBlockDragStart);
            block.addEventListener('dragend', handleBlockDragEnd);
        });
    
        initializeComponentDropZones();
    
        console.log('ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—åˆæœŸåŒ–å®Œäº†');
    }

    function handleBlockDragStart(e) {
        console.log('ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹:', this.dataset.blockName);
        draggedBlock = this;
    
        e.dataTransfer.setData('text/plain', this.dataset.blockId);
        e.dataTransfer.effectAllowed = 'move';
    
        this.classList.add('dragging');
    
        const dragImage = this.cloneNode(true);
        dragImage.style.width = '200px';
        dragImage.style.opacity = '0.8';
        dragImage.style.position = 'fixed';
        dragImage.style.left = '-1000px';
        document.body.appendChild(dragImage);
        e.dataTransfer.setDragImage(dragImage, 20, 20);
    
        setTimeout(() => {
            if (document.body.contains(dragImage)) {
                document.body.removeChild(dragImage);
            }
        }, 0);
    }

    function handleBlockDragEnd() {
        console.log('ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†');
        this.classList.remove('dragging');
        draggedBlock = null;
    
        document.querySelectorAll('.node').forEach(slot => {
            slot.classList.remove('drop-allowed', 'drop-not-allowed');
        });
    }

    // ==============================
    //  ç©æœ¨ã®å‰²ã‚Šå½“ã¦ / å‰Šé™¤ï¼ˆè¦‹ãŸç›®ï¼‰
    // ==============================
    async function assignBlockToComponent(componentId, blockId, blockName, componentType = 'node') {
        console.log('ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«ç©æœ¨ã‚’å‰²ã‚Šå½“ã¦:', {componentId, blockId, blockName, componentType});
        
        try {
            // ä»Šã¯ã€Œè¦‹ãŸç›®ã ã‘æ›´æ–°ã€ãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’è§¦ã‚‰ãªã„ï¼‰
            if (componentType === 'node') {
                updateComponentVisual(componentId, blockId, blockName);
                showMessage(`ç©æœ¨ã€Œ${blockName}ã€ã‚’é…ç½®ã—ã¾ã—ãŸ`, 'success');
                return;
            }
            
            const csrfToken = getCookie('csrftoken');
            const response = await fetch('/api/assign-block-to-slot/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    component_id: componentId,
                    block_id: blockId,
                    component_type: componentType
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                updateComponentVisual(componentId, blockId, blockName);
                showMessage('ç©æœ¨ã®å‰²ã‚Šå½“ã¦ã«æˆåŠŸã—ã¾ã—ãŸ', 'success');
            } else {
                throw new Error(data.message);
            }
        } catch (error) {
            console.error('ç©æœ¨å‰²ã‚Šå½“ã¦ã‚¨ãƒ©ãƒ¼:', error);
            showMessage('ç©æœ¨ã®å‰²ã‚Šå½“ã¦ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
        }
    }

    function updateComponentVisual(componentId, blockId, blockName) {
        const componentElement = document.querySelector(`[data-component-id="${componentId}"]`);
        if (componentElement) {
            const blockElement = document.querySelector(`[data-block-id="${blockId}"]`);
            const blockType = blockElement ? blockElement.dataset.blockType : null;
            const color = blockType ? (BLOCK_COLORS[blockType] || '#64748b') : '#64748b';
            const icon = blockType ? (BLOCK_ICONS[blockType] || 'ğŸ§©') : 'ğŸ§©';
            
            componentElement.innerHTML = `
                <div class="assigned-block">
                    <div class="block-info">
                        <div class="block-icon-small" style="background: ${color}">${icon}</div>
                        <span class="block-name-small">${blockName}</span>
                    </div>
                    <button class="remove-block" onclick="removeBlockFromComponent('${componentId}')">Ã—</button>
                </div>
            `;
            
            const removeBtn = componentElement.querySelector('.remove-block');
            if (removeBtn) {
                removeBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    removeBlockFromComponent(componentId);
                });
            }

            // â˜… æ–°é…ç½®ä¸€ä¸ªç§¯æœ¨ â†’ æ£€æŸ¥æ˜¯å¦å…¨éƒ¨å¡«æ»¡
            checkAllSlotsFilledAndShowSummary();
        }
    }


    async function removeBlockFromComponent(componentId) {
        if (!confirm('ã“ã®ä½ç½®ã‹ã‚‰ç©æœ¨ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
            return;
        }
        
        console.log('ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‹ã‚‰ç©æœ¨ã‚’å‰Šé™¤:', componentId);
        
        try {
            const componentElement = document.querySelector(`[data-component-id="${componentId}"]`);
            if (componentElement && nodeOriginalContent[componentId]) {
                componentElement.innerHTML = nodeOriginalContent[componentId];
                showMessage('ç©æœ¨ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
                // â˜… åˆ é™¤åä¹Ÿæ£€æŸ¥ä¸€æ¬¡
                checkAllSlotsFilledAndShowSummary();
            } else {
                showMessage('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        } catch (error) {
            console.error('ç©æœ¨å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
            showMessage('ç©æœ¨ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
        }
    }

    // ==============================
    //  ãƒ–ãƒ­ãƒƒã‚¯ä¸€è¦§ãƒ»ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ»ãƒ•ã‚£ãƒ«ã‚¿
    // ==============================
    function setupBlockColorsAndIcons() {
        const blockCards = document.querySelectorAll('.block-card');
        
        blockCards.forEach(card => {
            const blockType = card.dataset.blockType;
            const color = BLOCK_COLORS[blockType] || '#64748b';
            const icon = BLOCK_ICONS[blockType] || 'ğŸ§©';
            
            card.style.setProperty('--block-color', color);
            
            const iconElement = card.querySelector('.block-icon');
            if (iconElement) {
                iconElement.textContent = icon;
                iconElement.style.backgroundColor = color;
            }
            
            const typeElement = card.querySelector('.block-type');
            if (typeElement) {
                typeElement.style.backgroundColor = color;
            }
        });
    }

    function setupBlockClickEvents() {
        const blockCards = document.querySelectorAll('.block-card.unlocked');
        console.log(`${blockCards.length} å€‹ã®ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ãªç©æœ¨ã‚’è¦‹ã¤ã‘ã¾ã—ãŸ`);
        
        blockCards.forEach(card => {
            card.removeEventListener('click', handleBlockClick);
            card.addEventListener('click', handleBlockClick);
        });
    }

    function handleBlockClick(event) {
        if (event.target.classList.contains('remove-block') || 
            event.target.closest('.remove-block') ||
            event.target.classList.contains('block-type') ||
            this.classList.contains('locked')) {
            return;
        }
        
        const blockId = this.dataset.blockId;
        console.log('ç©æœ¨ã‚’ã‚¯ãƒªãƒƒã‚¯:', blockId);
        showBlockDetail(blockId);
    }

    function setupFilterTabs() {
        const tabs = document.querySelectorAll('.filter-tab');
        tabs.forEach(tab => {
            tab.addEventListener('click', function() {
                tabs.forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                const filter = this.dataset.filter;
                filterBlocks(filter);
            });
        });
    }

    function filterBlocks(filter) {
        const blocks = document.querySelectorAll('.block-card');
        blocks.forEach(block => {
            switch(filter) {
                case 'all':
                    block.style.display = 'block';
                    break;
                case 'unlocked':
                    block.style.display = block.classList.contains('unlocked') ? 'block' : 'none';
                    break;
                case 'locked':
                    block.style.display = block.classList.contains('locked') ? 'block' : 'none';
                    break;
            }
        });
    }

    function setupModalEvents() {
        const modal = document.getElementById('blockDetailModal');
        const closeBtn = document.getElementById('closeModalBtn');
        
        if (!modal || !closeBtn) {
            console.error('ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            return;
        }
        
        closeBtn.addEventListener('click', closeBlockDetail);
        
        modal.addEventListener('click', function(event) {
            if (event.target === modal) {
                closeBlockDetail();
            }
        });
        
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeBlockDetail();
            }
        });
        
        console.log('ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®šå®Œäº†');
    }

    async function showBlockDetail(blockId) {
        console.log('ç©æœ¨è©³ç´°ã‚’è¡¨ç¤º:', blockId);
    
        const modal = document.getElementById('blockDetailModal');
        const modalBody = document.getElementById('modalBody');
    
        if (!modal || !modalBody) {
            console.error('ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            showMessage('ãƒšãƒ¼ã‚¸ã®èª­ã¿è¾¼ã¿ã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚', 'error');
            return;
        }
    
        modalBody.innerHTML = '<div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>';
        modal.style.display = 'flex';
    
        try {
            const apiUrl = `/api/block-detail/${blockId}/`;
            console.log('API URL:', apiUrl);

            const response = await fetch(apiUrl);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data.success) {
                updateModalContent(data.block);
            } else {
                console.error('APIè¿”å´å¤±æ•—:', data.message);
                showMessage(data.message || 'ç©æœ¨è©³ç´°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                closeBlockDetail();
            }
        } catch (error) {
            console.error('APIãƒªã‚¯ã‚¨ã‚¹ãƒˆå¤±æ•—:', error);
            useMockData(blockId);
        }
    }

    function updateModalContent(blockData) {
        console.log('ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’æ›´æ–°:', blockData);
        
        const modalBody = document.getElementById('modalBody');
        const modalTitle = document.getElementById('modalBlockName');
        
        if (!modalBody || !modalTitle) {
            console.error('ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            return;
        }
        
        const color = BLOCK_COLORS[blockData.block_type] || '#64748b';
        
        modalTitle.textContent = blockData.name || 'ç©æœ¨è©³ç´°';
        
        modalBody.innerHTML = `
            <div class="block-detail-section">
                <h4>åŸºæœ¬æƒ…å ±</h4>
                <p>${blockData.description || 'èª¬æ˜ã¯ã¾ã è¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“'}</p>
                <div class="block-badge" style="background: ${color}20; color: ${color}">${blockData.block_type_display || 'ã‚¿ã‚¤ãƒ—æœªè¨­å®š'}</div>
            </div>
            
            <div class="block-detail-section">
                <h4>çŸ¥è­˜æ‹¡å¼µ</h4>
                <div class="expand-knowledge">
                    ${blockData.expand_knowledge || '<p class="no-content">æ‹¡å¼µçŸ¥è­˜ã¯ã¾ã è¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</p>'}
                </div>
            </div>
            
            ${blockData.usage_examples && blockData.usage_examples !== '// ä½¿ç”¨ä¾‹ã¯ã¾ã è¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“' ? `
            <div class="block-detail-section">
                <h4>ä½¿ç”¨ä¾‹</h4>
                <div class="expand-knowledge">
                    <pre><code>${blockData.usage_examples}</code></pre>
                </div>
            </div>
            ` : ''}
        `;
        
        console.log('ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„æ›´æ–°å®Œäº†');
    }

    function useMockData(blockId) {
        console.log('ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨:', blockId);
        
        const mockData = {
            name: 'ãƒ¢ãƒƒã‚¯ç©æœ¨ ' + blockId,
            description: 'ã“ã‚Œã¯ãƒ¢ãƒƒã‚¯ç©æœ¨ã®èª¬æ˜ã§ã™ã€‚å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚',
            block_type_display: 'DjangoåŸºç¤',
            expand_knowledge: '<p>ã“ã‚Œã¯ã“ã®ç©æœ¨ã«é–¢ã™ã‚‹æ‹¡å¼µçŸ¥è­˜ã§ã™ã€‚</p><p>å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚</p>',
            usage_examples: '# ä½¿ç”¨ä¾‹\nprint("Hello, World!")'
        };
        
        updateModalContent(mockData);
    }

    function closeBlockDetail() {
        const modal = document.getElementById('blockDetailModal');
        if (modal) {
            modal.style.display = 'none';
        }
    }

// ==============================
//  ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³ã®ä¿å­˜ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ç‰ˆï¼‰
// ==============================
async function saveArchitecture() {
    try {
        // ç”»é¢ä¸Šã®ç¾åœ¨ã®å‰²ã‚Šå½“ã¦ã‚’å–å¾—
        const currentAssignments = getCurrentSlotAssignments();

        if (Object.keys(currentAssignments).length === 0) {
            if (!confirm('ã¾ã ç©æœ¨ãŒé…ç½®ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ç©ºã®çŠ¶æ…‹ã§ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }
        }

        slotAssignments = currentAssignments;

        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
        localStorage.setItem(
            'architecture_slot_assignments_v1',
            JSON.stringify(currentAssignments)
        );

        console.log('ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜ã—ã¾ã—ãŸ:', currentAssignments);
        showMessage('ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼ˆã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã«è¨˜éŒ²ã•ã‚Œã¾ã™ï¼‰', 'success');
    } catch (error) {
        console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
        showMessage(`ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`, 'error');
    }
}

    function getCurrentSlotAssignments() {
        const assignments = {};
        let hasAssignments = false;
    
        const nodes = document.querySelectorAll('.node');
        nodes.forEach(node => {
            const componentId = node.dataset.componentId;
            const assignedBlock = node.querySelector('.assigned-block');
        
            if (assignedBlock && componentId) {
                const blockNameElement = assignedBlock.querySelector('.block-name-small');
                if (blockNameElement) {
                    const blockName = blockNameElement.textContent;
                    let blockId = null;
                
                    document.querySelectorAll('.block-card.unlocked').forEach(card => {
                        const cardName = card.querySelector('.block-name').textContent;
                        if (cardName === blockName) {
                            blockId = card.dataset.blockId;
                        }
                    });
                
                    assignments[componentId] = {
                        block_id: blockId,
                        block_name: blockName,
                        component_id: componentId
                    };
                    hasAssignments = true;
                }
            }
        });
    
        console.log('å½“å‰æ§½ä½åˆ†é…:', assignments);
        return hasAssignments ? assignments : {};
    }

function checkAllSlotsFilledAndShowSummary() {
        const msgBox = document.getElementById('completionMessage');
        if (!msgBox) return;

        // åªçœ‹çœŸæ­£çš„â€œæ§½ä½â€èŠ‚ç‚¹ï¼šæœ‰ data-component-id çš„ node
        // ï¼ˆhttpReq/userNode ä¸ç®—ï¼Œå‰é¢å·²ç»ç¦æ­¢æ‹–æ‹½ï¼‰
        const slots = Array.from(document.querySelectorAll('.node[data-component-id]'))
            .filter(slot => slot.id !== 'httpReq' && slot.id !== 'userNode');

        if (slots.length === 0) {
            msgBox.style.display = 'none';
            return;
        }

        const allFilled = slots.every(slot => {
            return !!slot.querySelector('.assigned-block');
        });

        msgBox.style.display = allFilled ? 'block' : 'none';
}
// ==============================
//  ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³ã®ãƒªã‚»ãƒƒãƒˆï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ã‚‚ã‚¯ãƒªã‚¢ï¼‰
// ==============================
async function resetArchitecture() {
    if (!confirm('ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿã™ã¹ã¦ã®ç©æœ¨å‰²ã‚Šå½“ã¦ãŒå‰Šé™¤ã•ã‚Œã¾ã™ã€‚')) {
        return;
    }

    console.log('ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’ãƒªã‚»ãƒƒãƒˆ...');

    try {
        const nodes = document.querySelectorAll('.node');
        nodes.forEach(node => {
            const componentId = node.dataset.componentId;
            if (componentId && nodeOriginalContent[componentId]) {
                node.innerHTML = nodeOriginalContent[componentId];
            }
        });

        slotAssignments = {};

        // ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ã‚‚å‰Šé™¤
        localStorage.removeItem('architecture_slot_assignments_v1');

        // â˜… é‡ç½®ä¹‹åæç¤ºæ¶ˆå¤±
        checkAllSlotsFilledAndShowSummary();

        showMessage('ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ', 'success');
    } catch (error) {
        console.error('ãƒªã‚»ãƒƒãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼:', error);
        showMessage('ãƒªã‚»ãƒƒãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
    }
}


    async function generateCode() {
        console.log('ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ...');
        
        try {
            const csrfToken = getCookie('csrftoken');
            const response = await fetch('/api/generate-architecture-code/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                document.getElementById('generatedCode').textContent = data.generated_code;
                document.getElementById('codePanel').style.display = 'block';
                showMessage('ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—ã¾ã—ãŸ', 'success');
            } else {
                showMessage(data.message || 'ã‚³ãƒ¼ãƒ‰ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        } catch (error) {
            console.error('ã‚³ãƒ¼ãƒ‰ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
            const generatedCode = `# ç”Ÿæˆã•ã‚ŒãŸDjangoã‚³ãƒ¼ãƒ‰\n\nfrom django.db import models\nfrom django.urls import path\nfrom django.shortcuts import render\n\n# ã‚¢ã‚¤ãƒ†ãƒ ãƒ¢ãƒ‡ãƒ«\nclass Item(models.Model):\n    name = models.CharField(max_length=200, verbose_name="ã‚¢ã‚¤ãƒ†ãƒ å")\n    price = models.DecimalField(max_digits=10, decimal_places=2, verbose_name="ä¾¡æ ¼")\n    \n    def __str__(self):\n        return self.name\n\n# ã‚¢ã‚¤ãƒ†ãƒ ãƒªã‚¹ãƒˆãƒ“ãƒ¥ãƒ¼\ndef item_list(request):\n    items = Item.objects.all()\n    return render(request, 'items/list.html', {'items': items})`;
            
            document.getElementById('generatedCode').textContent = generatedCode;
            document.getElementById('codePanel').style.display = 'block';
            showMessage('ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—ã¾ã—ãŸï¼ˆãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ï¼‰', 'success');
        }
    }

    function copyGeneratedCode() {
        const generatedCode = document.getElementById('generatedCode');
        if (!generatedCode) {
            console.error('ç”Ÿæˆã‚³ãƒ¼ãƒ‰è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            showMessage('ã‚³ãƒ”ãƒ¼ã™ã‚‹ã‚³ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
            return;
        }
        
        const code = generatedCode.textContent || generatedCode.innerText;
        
        navigator.clipboard.writeText(code).then(() => {
            console.log('ã‚³ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
            showMessage('ã‚³ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 'success');
        }).catch(err => {
            console.error('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã¸ã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—:', err);
            showMessage('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§ã‚³ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚', 'error');
        });
    }

    function downloadCode() {
        const generatedCode = document.getElementById('generatedCode');
        if (!generatedCode) {
            showMessage('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã‚³ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
            return;
        }
        
        const code = generatedCode.textContent || generatedCode.innerText;
        const blob = new Blob([code], { type: 'text/x-python' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = 'generated_code.py';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showMessage('ã‚³ãƒ¼ãƒ‰ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ', 'success');
    }

    function closeCodePanel() {
        const codePanel = document.getElementById('codePanel');
        if (codePanel) {
            codePanel.style.display = 'none';
        }
    }

    function useFallbackArchitectureData() {
        architectureData = {};
        renderArchitecture();
        drawSimplifiedConnections();
    }

    // ==============================
    //  ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
    // ==============================
    function showMessage(message, type) {
        const messageEl = document.createElement('div');
        messageEl.textContent = message;
        messageEl.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 14px 22px;
            border-radius: 10px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            transition: all 0.3s ease;
        `;
        
        if (type === 'success')      messageEl.style.background = 'var(--success-500)';
        else if (type === 'error')   messageEl.style.background = 'var(--error-500)';
        else                         messageEl.style.background = 'var(--primary-500)';
        
        document.body.appendChild(messageEl);
        
        setTimeout(() => {
            messageEl.style.opacity = '0';
            setTimeout(() => {
                if (messageEl.parentNode) {
                    messageEl.parentNode.removeChild(messageEl);
                }
            }, 300);
        }, 3000);
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    window.addEventListener('resize', function() {
        drawSimplifiedConnections();
    });

    function centerOf(el) {
        const p = el.getBoundingClientRect();
        const host = el.closest('.canvas-container') || document.body;
        const base = host.getBoundingClientRect();
        return { x: p.left - base.left + p.width/2, y: p.top - base.top + p.height/2 };
    }
    function rightCenterOf(el) {
        const p = el.getBoundingClientRect();
        const host = el.closest('.canvas-container') || document.body;
        const base = host.getBoundingClientRect();
        return { x: p.left - base.left + p.width, y: p.top - base.top + p.height/2 };
    }
    function leftCenterOf(el) {
        const p = el.getBoundingClientRect();
        const host = el.closest('.canvas-container') || document.body;
        const base = host.getBoundingClientRect();
        return { x: p.left - base.left, y: p.top - base.top + p.height/2 };
    }
    function bottomCenterOf(el) {
        const p = el.getBoundingClientRect();
        const host = el.closest('.canvas-container') || document.body;
        const base = host.getBoundingClientRect();
        return { x: p.left - base.left + p.width/2, y: p.top - base.top + p.height };
    }
    function topCenterOf(el) {
        const p = el.getBoundingClientRect();
        const host = el.closest('.canvas-container') || document.body;
        const base = host.getBoundingClientRect();
        return { x: p.left - base.left + p.width/2, y: p.top - base.top };
    }
</script>
{% endblock %}